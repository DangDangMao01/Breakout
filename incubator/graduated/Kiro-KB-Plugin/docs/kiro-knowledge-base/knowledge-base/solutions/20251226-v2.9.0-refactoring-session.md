---
domain: vscode-extension
tags: [kiro-kb, refactoring, i18n, typescript, unit-test]
date: 2025-12-26
source_project: "kiro-knowledge-base"
value_score: 8
---

# Kiro KB 插件 v2.9.0 代码重构

## 背景

v2.8.0 完成 Bug 修复和功能改进后，代码存在以下问题：
- 国际化文本内联在 extension.ts 中，难以维护
- 部分类型使用 `any`，类型安全性不足
- 缺少单元测试

## 重构内容

### 1. 国际化模块抽取 (`src/i18n.ts`)

```typescript
export type Language = 'zh' | 'en';
export type I18nKey = keyof typeof zh;

let currentLang: Language = 'zh';

export function setLanguage(lang: Language): void { currentLang = lang; }
export function getLanguage(): Language { return currentLang; }
export function isZh(): boolean { return currentLang === 'zh'; }

export function t(key: I18nKey | string, ...args: (string | number)[]): string {
    let text = i18n[currentLang]?.[key] || i18n['zh'][key] || key;
    args.forEach((arg, i) => { text = text.replace(`{${i}}`, String(arg)); });
    return text;
}
```

**使用方式变更：**
- `currentLanguage === 'zh'` → `isZh()`
- `currentLanguage = 'en'` → `setLanguage('en')`
- 直接字符串 → `t('keyName')`

### 2. 类型定义模块 (`src/types.ts`)

定义了 15+ 类型：
- `BacklogItem` - 待办项
- `SmartAnalysisResult` - 智能分析结果
- `RelatedFile` - 相关文件
- `KBFileInfo` / `CentralKBFileInfo` - 知识库文件信息
- `KBValidationResult` - 验证结果
- `LogLevel` - 日志级别
- `PluginConfig` - 插件配置

### 3. 单元测试 (`src/test/extension.test.ts`)

测试覆盖：
- i18n 模块（语言切换、翻译函数）
- 类型定义验证
- 智能分析逻辑（Bug/Feature/Idea 检测、优先级检测）
- 文件名生成
- 路径处理（知识库结构判断）
- 日期计算

## 关键代码

**extension.ts 导入变更：**
```typescript
import { t, setLanguage, getLanguage, isZh, type Language } from './i18n';
import type { BacklogItem, SmartAnalysisResult, ... } from './types';
```

**loadConfiguration 使用 setLanguage：**
```typescript
function loadConfiguration() {
    const config = vscode.workspace.getConfiguration('kiro-kb');
    setLanguage((config.get<string>('language') || 'zh') as Language);
    // ...
}
```

## 版本变更

- v2.8.0 → v2.9.0
- 新增文件：`i18n.ts`, `types.ts`, `test/extension.test.ts`
- 编译输出增加：`i18n.js`, `types.js`, `test/extension.test.js`

## 注意事项

1. 所有 `currentLanguage` 引用已替换为 i18n 模块函数
2. 类型导入使用 `import type` 避免运行时开销
3. 测试文件模拟了核心逻辑，不依赖 VS Code API
