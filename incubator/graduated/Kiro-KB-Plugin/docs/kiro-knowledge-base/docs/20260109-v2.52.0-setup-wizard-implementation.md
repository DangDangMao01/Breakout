# v2.52.0 首次使用引导实现总结

> 实现日期：2026-01-09  
> 模块：setupWizard.ts  
> 状态：✅ 已完成

---

## 📋 实现概述

v2.52.0 新增 `setupWizard.ts` 模块，实现首次使用引导和路径验证功能，解决跨设备使用时的配置问题。

---

## ✨ 核心功能

### 1. 启动时路径验证 ✅

**函数**：`validateSetup(): Promise<SetupValidationResult>`

**验证场景**：
- ✅ 情况1：没有配置 → `reason: 'no-config'`
- ✅ 情况2：路径无效（跨设备同步后常见）→ `reason: 'path-invalid'`
- ✅ 情况3：路径有效但目录结构不完整 → `reason: 'structure-incomplete'`
- ✅ 情况4：一切正常 → `reason: 'valid'`

**返回类型**：
```typescript
interface SetupValidationResult {
    isValid: boolean;
    reason: 'no-config' | 'path-invalid' | 'structure-incomplete' | 'valid';
    centralPath?: string;
}
```

### 2. 首次设置向导 ✅

**函数**：`showFirstTimeSetup(): Promise<boolean>`

**流程**：

**Step 1: 欢迎界面**
```
🎉 欢迎使用 Kiro Knowledge Base！

这个插件帮你管理技术笔记和解决方案。

[开始设置] [查看教程]
```

**Step 2: 自动检测或选择路径**
- 调用 `autoDetectKnowledgeBase()` 自动检测
- 检测优先级：
  1. 环境变量 `KIRO_KB_PATH`
  2. 常见位置（`~/Kiro-Central-KB`、`~/Documents/Kiro-KB`、`D:\G_GitHub\Kiro-Central-KB` 等）
- 检测到时询问是否使用
- 未检测到时打开文件夹选择对话框

**Step 3: 初始化知识库**
- 调用 `initializeKnowledgeBase(selectedPath)`
- 创建完整目录结构
- 生成初始文件（README.md、INDEX.md、.gitignore）
- 保存配置到 `kiro-kb.centralPath`

**Step 4: 用户方向选择（v2.53.0）**
- 调用 `UserDirectionSelector.showDirectionSelection()`
- 使用模态对话框，确保用户看到提示
- 清晰说明"工作方向"的含义（如游戏开发、前端开发等）
- 用户选择工作方向（游戏开发、游戏美术等）
- 根据选择自动创建初始领域（如 tools/unity, tools/blender）
- 生成用户画像文件
- **错误处理**：
  - 使用 try-catch 包裹，确保即使失败也不影响整体设置流程
  - 详细的控制台日志（`[Kiro KB]` 前缀）用于调试
  - 失败时向用户显示警告消息，说明具体错误原因
  - 用户可以跳过此步骤，稍后手动配置
- 显示成功提示

### 3. 路径无效提示 ✅

**函数**：`showPathInvalidPrompt(invalidPath: string): Promise<boolean>`

**场景**：跨设备同步后，配置的路径在当前设备上不存在

**用户选项**：
- ✅ **重新选择路径** → 调用完整的首次设置流程（v2.53.0: 包括用户方向选择）
- ✅ **创建此目录** → 在原路径创建完整知识库结构
- ✅ **暂时忽略** → 关闭对话框，不做任何操作

### 4. 结构不完整提示 ✅

**函数**：`showInitializePrompt(kbPath: string): Promise<boolean>`

**场景**：路径存在但缺少必要的目录或文件

**用户选项**：
- ✅ **补全** → 自动补全缺失的目录和文件
- ✅ **取消** → 不做任何操作

### 5. 自动检测知识库位置 ✅

**函数**：`autoDetectKnowledgeBase(): Promise<string | null>`

**检测优先级**：
1. 环境变量 `KIRO_KB_PATH`
2. 常见位置：
   - `~/Kiro-Central-KB`
   - `~/Documents/Kiro-KB`
   - `~/Documents/Knowledge-Base`
   - `D:\G_GitHub\Kiro-Central-KB`（用户常用路径）
   - `C:\Users\Public\Kiro-KB`

**验证条件**：
- 路径存在
- 通过 `hasValidStructure()` 验证（至少有 2 个核心文件夹）

### 6. 知识库初始化 ✅

**函数**：`initializeKnowledgeBase(basePath: string): Promise<boolean>`

**创建内容**：

**目录结构**：
```
basePath/
├── solutions/      # 问题解决方案（旧结构，保留兼容）
├── notes/          # 学习笔记（旧结构，保留兼容）
├── discussions/    # 技术探讨（旧结构，保留兼容）
├── backlog/        # 待整理问题（旧结构，保留兼容）
├── domains/        # v2.53.0: 按领域分类（新结构）
├── profile/        # v2.53.0: 用户画像（新结构）
└── inbox/          # v2.53.0: 待整理（新结构）
```

**文件生成**：
- ✅ `README.md` - 知识库说明文档（含目录结构、快速开始、使用技巧）
- ✅ `INDEX.md` - 知识库索引（含统计表格、最近更新、分类列表）
- ✅ `.gitignore` - Git 忽略规则（`*.tmp`, `.DS_Store`, `node_modules/`）
- ✅ `profile/user-profile.yaml` - v2.53.0: 用户画像文件（含基本信息、擅长领域、学习记录）

### 7. 重置插件配置 ✅

**函数**：`resetPluginConfiguration(): Promise<void>`

**功能**：
- ✅ 清除所有配置（centralPath、autoSave、autoSync、lastOpenTime）
- ✅ 不删除知识库文件（安全）
- ✅ 提示重新加载窗口

**使用场景**：
- 跨设备同步后配置混乱
- 插件行为异常
- 想重新配置

---

## 📊 类型定义

### SetupValidationResult
```typescript
interface SetupValidationResult {
    isValid: boolean;
    reason: 'no-config' | 'path-invalid' | 'structure-incomplete' | 'valid';
    centralPath?: string;
}
```

### KB_STRUCTURE
```typescript
const KB_STRUCTURE = {
    folders: [
        'solutions',      // 旧结构：保留向后兼容
        'notes',          // 旧结构：保留向后兼容
        'discussions',    // 旧结构：保留向后兼容
        'backlog',        // 旧结构：保留向后兼容
        'domains',        // v2.53.0: 新结构 - 按领域分类
        'profile',        // v2.53.0: 新结构 - 用户画像
        'inbox'           // v2.53.0: 新结构 - 待整理
    ],
    files: {
        'README.md': generateReadmeContent,
        'INDEX.md': generateIndexContent,
        '.gitignore': () => '*.tmp\n.DS_Store\nnode_modules/\n',
        'profile/user-profile.yaml': generateUserProfileContent  // v2.53.0: 用户画像
    }
};
```

---

## 🔧 辅助函数

### hasValidStructure(dirPath: string): boolean
- 检查目录结构是否完整
- 要求：至少有 2 个核心文件夹（solutions、notes、discussions）

### selectKnowledgeBasePath(): Promise<string | undefined>
- 打开文件夹选择对话框
- 标题：选择或创建知识库文件夹

### generateReadmeContent(): string
- 生成 README.md 内容
- 包含：目录结构、快速开始、使用技巧、更多信息

### generateIndexContent(): string
- 生成 INDEX.md 内容
- 包含：统计表格、最近更新、按领域分类、按类型分类

### generateUserProfileContent(): string (v2.53.0)
- 生成用户画像文件内容
- 包含：基本信息、初始兴趣、擅长领域、正在学习、偏好设置、工作模式、当前项目、使用统计
- 用于让 AI 越来越懂用户

---

## 🌐 国际化支持

使用 `i18n.ts` 模块的 `isZh()` 函数判断语言：
- ✅ 所有用户界面文本支持中英文
- ✅ 对话框标题、按钮、提示信息全部国际化
- ✅ 生成的 README.md 和 INDEX.md 支持中英文

---

## 🎯 使用场景

### 场景 1：首次安装
1. 用户安装插件
2. 启动时检测到 `centralPath` 为空
3. 自动显示首次设置向导
4. 用户完成 3 步设置
5. 开始使用

### 场景 2：跨设备同步
1. 用户在设备 A 配置了 `D:\G_GitHub\Kiro-Central-KB`
2. 切换到设备 B（路径不存在）
3. 启动时检测到路径无效
4. 显示路径无效提示
5. 用户选择：
   - 重新选择路径 → 进入完整的首次设置流程（v2.53.0: 包括选择工作方向）
   - 创建此目录 → 在设备 B 创建相同路径
   - 暂时忽略 → 稍后手动处理

### 场景 3：结构不完整
1. 用户手动创建了知识库文件夹
2. 但缺少某些子目录
3. 启动时检测到结构不完整
4. 显示补全提示
5. 用户选择补全 → 自动创建缺失目录和文件

### 场景 4：重置配置
1. 用户遇到配置问题
2. 执行 `Kiro KB: 重置插件配置`
3. 清除所有配置
4. 重新加载窗口
5. 触发首次设置向导

---

## ✅ 验收标准

### 功能完整性
- ✅ 所有函数已实现
- ✅ 所有场景已覆盖
- ✅ 错误处理完善

### 用户体验
- ✅ 首次安装到开始使用 ≤ 60 秒
- ✅ 无需阅读文档即可使用
- ✅ 错误提示清晰明确
- ✅ 跨设备场景处理完善

### 代码质量
- ✅ TypeScript 类型定义完整
- ✅ 函数职责单一
- ✅ 错误处理完善（v2.53.0: 用户方向选择添加 try-catch）
- ✅ 国际化支持完整

---

## 📝 待集成

### extension.ts 集成
```typescript
// 在 activate() 函数中添加
import { validateSetup, showFirstTimeSetup, showPathInvalidPrompt, showInitializePrompt } from './setupWizard';

export async function activate(context: vscode.ExtensionContext) {
    // ... 现有代码
    
    // 启动时验证设置
    const validation = await validateSetup();
    
    if (!validation.isValid) {
        switch (validation.reason) {
            case 'no-config':
                await showFirstTimeSetup();
                break;
            case 'path-invalid':
                await showPathInvalidPrompt(validation.centralPath!);
                break;
            case 'structure-incomplete':
                await showInitializePrompt(validation.centralPath!);
                break;
        }
    }
    
    // ... 现有代码
}
```

### 命令注册
```typescript
// 注册重置配置命令
context.subscriptions.push(
    vscode.commands.registerCommand('kiro-kb.resetConfiguration', resetPluginConfiguration)
);
```

---

## 🔗 相关文档

- [v2.52.0 UX 改进计划](./v2.52.0-ux-improvement-plan.md) - 完整设计方案
- [跨设备开发工作流](../../CROSS-DEVICE-WORKFLOW.md) - 跨设备使用指南
- [i18n.ts](../extension/src/i18n.ts) - 国际化模块

---

## 💡 设计亮点

1. **零配置启动**：自动检测常见位置，大多数用户无需手动配置
2. **跨设备友好**：专门处理跨设备同步后的路径问题
3. **智能补全**：检测到结构不完整时自动补全，而不是报错
4. **安全重置**：重置配置不删除知识库文件，保证数据安全
5. **完整国际化**：所有用户界面支持中英文
6. **清晰的错误提示**：每个错误都有明确的原因和解决方案
7. **健壮的错误处理**（v2.53.0）：
   - 用户方向选择失败不影响整体设置流程
   - 详细的调试日志帮助排查问题
   - 失败时向用户显示清晰的错误信息

---

*实现日期：2026-01-09*  
*模块文件：kiro-knowledge-base/extension/src/setupWizard.ts*  
*代码行数：421 行*
