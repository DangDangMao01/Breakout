# v2.50.0 Ollama 集成 Bug 研究文档

> 状态：**暂时搁置** | 原因：Kiro IDE 限制 | 日期：2026-01-09

---

## 📋 问题概述

### 症状
- 插件无法正常加载
- 左侧面板显示"没有可提供视图数据的已注册数据提供程序"
- 输出通道列表中没有 "Kiro Knowledge Base"
- 插件根本没有正确激活

### 触发条件
在 v2.49.0 中添加 Ollama AI 集成功能后出现

---

## 🔍 根本原因分析

### 1. 初始化顺序问题

```typescript
// ❌ 问题代码：Ollama 初始化阻塞了核心组件
export async function activate(context: vscode.ExtensionContext) {
    // Ollama 初始化在前，如果失败会阻止后续代码执行
    await initializeOllama();  // 这里如果出错，整个插件崩溃
    
    // 核心组件初始化
    outputChannel = vscode.window.createOutputChannel('Kiro Knowledge Base');
    // ...
}
```

### 2. Kiro IDE 特殊限制

**关键发现**：Kiro IDE 对某些 VSCode API 的支持与标准 VSCode 不同

| API | VSCode | Kiro IDE |
|-----|--------|----------|
| `http.request` | ✅ 正常 | ⚠️ 可能受限 |
| `fetch` | ✅ 正常 | ⚠️ 可能受限 |
| 外部网络请求 | ✅ 正常 | ⚠️ 需要特殊处理 |
| `child_process` | ✅ 正常 | ⚠️ 可能受限 |

### 3. 错误隔离不足

```typescript
// ❌ 问题：未捕获的异常导致整个插件崩溃
try {
    const response = await fetch('http://localhost:11434/api/tags');
} catch (e) {
    // 这个 catch 可能没有正确捕获所有错误类型
}
```

---

## 🧪 尝试过的修复方案

### 方案 1：调整初始化顺序 ❌

```typescript
// 尝试：核心功能优先，Ollama 延迟初始化
export function activate(context: vscode.ExtensionContext) {
    // 1. 核心组件先初始化
    outputChannel = vscode.window.createOutputChannel('Kiro Knowledge Base');
    knowledgePanelProvider = new KnowledgePanelProvider(context);
    
    // 2. Ollama 延迟初始化
    setTimeout(() => {
        initializeOllama().catch(e => log(e));
    }, 1000);
}
```

**结果**：仍然失败，问题不仅仅是顺序

### 方案 2：完全异步隔离 ❌

```typescript
// 尝试：使用 Promise 完全隔离
setTimeout(async () => {
    try {
        await initializeOllama();
    } catch (e) {
        // 静默失败
    }
}, 0);
```

**结果**：仍然失败

### 方案 3：移除 Ollama 功能 ✅

```typescript
// 临时方案：完全移除 Ollama 相关代码
// 插件恢复正常
```

**结果**：成功，但失去了 AI 功能

---

## 🎯 核心问题定位

### Kiro IDE 的网络请求限制

Kiro IDE 可能对插件的网络请求有特殊限制：

1. **沙箱环境**：插件可能运行在受限的沙箱中
2. **localhost 访问**：对 localhost 的访问可能被拦截
3. **HTTP 模块**：Node.js 的 http 模块可能被修改

### 证据

1. 相同代码在标准 VSCode 中可能正常工作
2. 移除网络请求后插件恢复正常
3. 错误发生在网络请求初始化阶段

---

## 📝 Ollama 集成代码（保留参考）

### ollama.ts

```typescript
/**
 * Ollama AI 集成模块
 * v2.49.0 - 本地 AI 功能
 * 
 * 状态：因 Kiro IDE 限制暂时禁用
 */

import * as vscode from 'vscode';
import * as http from 'http';

export interface OllamaConfig {
    baseUrl: string;
    model: string;
    timeout: number;
}

export class OllamaClient {
    private config: OllamaConfig;
    
    constructor(config?: Partial<OllamaConfig>) {
        this.config = {
            baseUrl: config?.baseUrl || 'http://localhost:11434',
            model: config?.model || 'qwen2.5:7b',
            timeout: config?.timeout || 30000
        };
    }
    
    /**
     * 检查 Ollama 服务是否可用
     */
    async isAvailable(): Promise<boolean> {
        return new Promise((resolve) => {
            const url = new URL('/api/tags', this.config.baseUrl);
            
            const req = http.request({
                hostname: url.hostname,
                port: url.port,
                path: url.pathname,
                method: 'GET',
                timeout: 5000
            }, (res) => {
                resolve(res.statusCode === 200);
            });
            
            req.on('error', () => resolve(false));
            req.on('timeout', () => {
                req.destroy();
                resolve(false);
            });
            
            req.end();
        });
    }
    
    /**
     * 生成文本
     */
    async generate(prompt: string): Promise<string> {
        return new Promise((resolve, reject) => {
            const url = new URL('/api/generate', this.config.baseUrl);
            
            const postData = JSON.stringify({
                model: this.config.model,
                prompt: prompt,
                stream: false
            });
            
            const req = http.request({
                hostname: url.hostname,
                port: url.port,
                path: url.pathname,
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': Buffer.byteLength(postData)
                },
                timeout: this.config.timeout
            }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                    try {
                        const json = JSON.parse(data);
                        resolve(json.response || '');
                    } catch (e) {
                        reject(new Error('Invalid response'));
                    }
                });
            });
            
            req.on('error', reject);
            req.on('timeout', () => {
                req.destroy();
                reject(new Error('Request timeout'));
            });
            
            req.write(postData);
            req.end();
        });
    }
}
```

### 计划的功能

1. **智能分类**：使用 AI 自动分类知识文档
2. **内容摘要**：自动生成文档摘要
3. **语义搜索**：基于语义的知识搜索
4. **智能标签**：自动生成标签建议

---

## 🔮 后续研究方向

### 1. 调查 Kiro IDE 网络限制

- [ ] 查阅 Kiro IDE 官方文档
- [ ] 测试其他网络请求方式
- [ ] 联系 Kiro 团队咨询

### 2. 替代方案

| 方案 | 可行性 | 说明 |
|------|--------|------|
| WebSocket | 待测试 | 可能绕过 HTTP 限制 |
| 外部进程 | 待测试 | 通过 CLI 调用 Ollama |
| 浏览器 API | 待测试 | 使用 webview 发起请求 |
| 等待 Kiro 更新 | 被动 | 等待官方支持 |

### 3. 功能降级方案

如果无法使用本地 AI，考虑：
- 使用规则引擎替代 AI 分类
- 使用关键词匹配替代语义搜索
- 保留 AI 功能入口，等待未来支持

---

## 📊 版本历史

| 版本 | 日期 | 状态 | 说明 |
|------|------|------|------|
| v2.49.0 | 2026-01-07 | ❌ 失败 | 首次尝试集成 Ollama |
| v2.50.0 | 2026-01-08 | ⏸️ 搁置 | Bug 修复尝试，未成功 |
| v2.51.0 | 2026-01-09 | ✅ 跳过 | 移除 Ollama，添加其他功能 |

---

## 📎 相关文件

- `kiro-knowledge-base/RELEASE-NOTES-v2.50.0.md` - 原始发布说明
- `kiro-knowledge-base/extension/src/ollama.ts` - Ollama 客户端代码（已禁用）
- `kiro-knowledge-base/INSTALL-v2.50.0.md` - 安装指南

---

## 💡 经验教训

1. **新功能需要充分测试**：特别是涉及网络请求的功能
2. **了解目标平台限制**：Kiro IDE 与标准 VSCode 有差异
3. **错误隔离很重要**：新功能不应影响核心功能
4. **保留回退方案**：始终保持可回退到稳定版本

---

*文档创建：2026-01-09*  
*最后更新：2026-01-09*
