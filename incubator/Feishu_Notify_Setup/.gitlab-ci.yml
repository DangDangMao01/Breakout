stages:
  - notify

notify_art_update:
  stage: notify
  tags:
    - windows
  variables:
    GIT_STRATEGY: none
    PYTHONIOENCODING: "utf-8"
    FEISHU_APP_ID: "cli_a9e3400711fbdbcb"
    FEISHU_APP_SECRET: "h61QXukkibdbO0wRRFxTkgppaLvcPQFS"
  script:
    - '[Console]::OutputEncoding = [System.Text.Encoding]::UTF8'
    - '$OutputEncoding = [System.Text.Encoding]::UTF8'
    - Write-Host "=== 开始美术资源变动检测 ==="
    - Set-Location C:\GitLab-Runner
    - Write-Host "[调试] GITLAB_USER_EMAIL=$env:GITLAB_USER_EMAIL"
    - Write-Host "[调试] GITLAB_USER_LOGIN=$env:GITLAB_USER_LOGIN"
    - if ($env:GITLAB_USER_EMAIL) { $env:GITLAB_USER_EMAIL.Split('@')[0] | Out-File -Encoding UTF8 -NoNewline "commit_user.txt" } elseif ($env:GITLAB_USER_LOGIN) { $env:GITLAB_USER_LOGIN | Out-File -Encoding UTF8 -NoNewline "commit_user.txt" } else { "Unknown User" | Out-File -Encoding UTF8 -NoNewline "commit_user.txt" }
    - $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"; "Resource updated at $timestamp" | Out-File -Encoding UTF8 -NoNewline "commit_msg.txt"
    - $env:USE_FILE_MODE = "true"
    - $env:CI_PROJECT_PATH = "GroupTwoGame/groupTowArt_Hb"
    - $env:CI_COMMIT_SHA = "unknown"
    - $env:CI_PROJECT_URL = "https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb"
    - $env:FEISHU_APP_ID = "cli_a9e3400711fbdbcb"
    - $env:FEISHU_APP_SECRET = "h61QXukkibdbO0wRRFxTkgppaLvcPQFS"
    - C:\Users\Administrator\AppData\Local\Programs\Python\Python314\python.exe notify.py
  only:
    changes:
      - "**/*"
  allow_failure: true
  retry: 1
