# 周一测试清单

**日期**: 2026-01-27（周一）  
**任务**: 测试 GitLab Webhook 飞书通知系统

---

## 📋 测试前准备

### 1. 确认当前状态

- [x] Webhook 服务器代码已完成
- [x] 一键部署脚本已完成
- [x] 文档已完成
- [ ] GitLab 管理员权限（待确认）

### 2. 需要确认的问题

**问题 1**: 你是否有 GitLab 管理员权限？

**检查方法**：
1. 登录 GitLab: https://gitlab.huixuanjiasu.com
2. 查看左侧菜单
3. 如果看到 **Admin Area**（扳手图标），说明有管理员权限

**结果**：
- [ ] 有管理员权限 → 使用方案 A
- [ ] 没有管理员权限 → 使用方案 B

---

## 🎯 方案 A：有管理员权限（推荐）

### 步骤 1：开启 GitLab 本地网络请求权限

1. 登录 GitLab
2. 进入 **Admin Area**（管理中心）
3. 进入 **Settings** → **Network**
4. 展开 **Outbound requests**
5. 勾选 **"Allow requests to the local network from webhooks and integrations"**
6. 点击 **Save changes**

### 步骤 2：启动 Webhook 服务器

```bash
cd Feishu_Notify_Setup\webhook_server
启动Webhook服务器.bat
```

**验证**：
- [ ] 服务器启动成功
- [ ] 显示监听地址: http://0.0.0.0:5000
- [ ] 显示 Webhook URL: http://172.22.96.1:5000/gitlab-webhook

### 步骤 3：配置 GitLab Webhook

1. 打开 GitLab 项目: https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb
2. 进入 **Settings** → **Webhooks**
3. 填写配置：
   ```
   URL: http://172.22.96.1:5000/gitlab-webhook
   Secret Token: (留空)
   Trigger: ✅ Push events
   SSL verification: ❌ 取消勾选
   ```
4. 点击 **Add webhook**
5. 点击 **Test** → **Push events**

**验证**：
- [ ] 看到 "Hook executed successfully: HTTP 200"
- [ ] 服务器控制台有日志输出
- [ ] 飞书收到测试通知

### 步骤 4：提交代码测试

```bash
cd D:\HuiXuanJiaSu\I_IAA_Work
git add .
git commit -m "测试 Webhook 通知"
git push
```

**验证**：
- [ ] 服务器控制台有日志输出
- [ ] 飞书收到通知
- [ ] 提交人显示正确
- [ ] 提交信息显示正确（中文无乱码）

---

## 🎯 方案 B：没有管理员权限

### 步骤 1：联系 GitLab 管理员

**发送以下消息给管理员**：

```
【需求】开启 GitLab Webhook 本地网络请求

我需要配置 GitLab Webhook 向内网服务器发送通知。

请帮忙开启以下设置：

路径：Admin Area → Settings → Network → Outbound requests
设置：勾选 "Allow requests to the local network from webhooks and integrations"

目标 IP: 172.22.96.1:5000
用途: 飞书通知系统

感谢！
```

### 步骤 2：等待管理员配置

- [ ] 已发送请求给管理员
- [ ] 管理员已确认收到
- [ ] 管理员已完成配置

### 步骤 3：配置完成后，按照方案 A 的步骤 2-4 测试

---

## 🔧 备用方案：使用 GitLab CI（如果 Webhook 无法使用）

### 步骤 1：禁用 Webhook（如果已配置）

1. 进入 GitLab 项目
2. Settings → Webhooks
3. 删除或禁用 Webhook

### 步骤 2：启用 GitLab CI 通知

`.gitlab-ci.yml` 已经配置好了，只需要确认：

- [ ] `notify` 任务未被注释
- [ ] 环境变量已配置（FEISHU_APP_ID, FEISHU_APP_SECRET）
- [ ] 脚本文件已复制到 `C:\GitLab-Runner\`

### 步骤 3：提交代码测试

```bash
cd D:\HuiXuanJiaSu\I_IAA_Work
git add .
git commit -m "测试 GitLab CI 通知"
git push
```

**验证**：
- [ ] GitLab CI Pipeline 运行成功
- [ ] notify 任务执行成功
- [ ] 飞书收到通知

**注意**：
- ⚠️ 可能有中文乱码问题
- ⚠️ 提交人可能显示为 "Unknown User"
- 💡 参考 `docs/关键经验-必读.md` 解决问题

---

## 🧪 测试工具

### 本地测试（不需要 GitLab）

```bash
cd Feishu_Notify_Setup\webhook_server
测试Webhook.bat
```

**用途**：
- 验证 Webhook 服务器功能
- 验证飞书通知功能
- 不需要 GitLab 配置

### 环境检查

```bash
cd Feishu_Notify_Setup\webhook_server
检查环境.bat
```

**用途**：
- 检查 Python 环境
- 检查依赖库
- 检查网络配置
- 检查防火墙规则

---

## 📊 测试结果记录

### 方案 A 测试结果

| 步骤 | 状态 | 备注 |
|------|------|------|
| 开启 GitLab 权限 | ⬜ 待测试 | |
| 启动 Webhook 服务器 | ⬜ 待测试 | |
| 配置 GitLab Webhook | ⬜ 待测试 | |
| Webhook 测试 | ⬜ 待测试 | |
| 提交代码测试 | ⬜ 待测试 | |
| 提交人显示正确 | ⬜ 待测试 | |
| 中文无乱码 | ⬜ 待测试 | |

### 方案 B 测试结果

| 步骤 | 状态 | 备注 |
|------|------|------|
| 联系管理员 | ⬜ 待测试 | |
| 管理员配置完成 | ⬜ 待测试 | |
| 后续测试 | ⬜ 待测试 | |

### 备用方案测试结果

| 步骤 | 状态 | 备注 |
|------|------|------|
| GitLab CI 通知 | ⬜ 待测试 | |
| 中文显示 | ⬜ 待测试 | |
| 提交人显示 | ⬜ 待测试 | |

---

## 🐛 常见问题

### 问题 1：服务器无法启动

**错误**: `ModuleNotFoundError: No module named 'flask'`

**解决**:
```bash
cd Feishu_Notify_Setup\webhook_server
一键部署.bat
```

### 问题 2：IP 地址变化

**检查当前 IP**:
```bash
ipconfig
```

**如果 IP 变了**:
- 更新 GitLab Webhook URL
- 或设置静态 IP

### 问题 3：防火墙阻止

**开放 5000 端口**（以管理员身份运行 PowerShell）:
```powershell
New-NetFirewallRule -DisplayName "Webhook Server" -Direction Inbound -LocalPort 5000 -Protocol TCP -Action Allow
```

### 问题 4：GitLab 无法连接

**错误**: "URL 已被阻止: 不允许向本地网络发出请求"

**解决**: 需要管理员开启权限（见方案 A 步骤 1）

---

## 📞 需要帮助？

### 查看文档

- **快速指南**: `webhook_server/快速部署指南.md`
- **完整文档**: `webhook_server/README.md`
- **关键经验**: `docs/关键经验-必读.md`
- **方案对比**: `docs/GitLab-CI-vs-Webhook方案对比.md`

### 运行诊断

```bash
cd Feishu_Notify_Setup\webhook_server
检查环境.bat
```

### 联系技术支持

如果遇到问题，提供以下信息：
1. `环境检查报告.txt`
2. 服务器控制台日志
3. GitLab Webhook 测试结果
4. 错误截图

---

## ✅ 测试完成后

### 如果测试成功

1. **更新文档**
   - 记录实际的 IP 地址
   - 记录遇到的问题和解决方案
   - 更新测试结果

2. **分享给同事**
   - 打包 `Feishu_Notify_Setup` 文件夹
   - 分享 `给同事的使用说明.md`
   - 提供技术支持

3. **禁用旧方案**（如果使用 Webhook）
   - 注释 `.gitlab-ci.yml` 中的 `notify` 任务
   - 提交修改

### 如果测试失败

1. **记录问题**
   - 错误信息
   - 环境检查报告
   - 尝试过的解决方案

2. **寻求帮助**
   - 联系 GitLab 管理员
   - 查看文档
   - 或使用备用方案

---

## 🎯 成功标准

测试成功的标准：

- ✅ Webhook 服务器正常运行
- ✅ GitLab Webhook 配置成功
- ✅ 提交代码后收到飞书通知
- ✅ 提交人显示正确（不是 "Unknown User"）
- ✅ 提交信息显示正确（中文无乱码）
- ✅ 通知消息格式美观

---

**祝测试顺利！** 🚀

**创建时间**: 2026-01-23（周五）  
**测试时间**: 2026-01-27（周一）  
**预计耗时**: 30 分钟
