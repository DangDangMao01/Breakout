# 飞书工作配方部署指南

**方案类型**: 飞书官方工作配方（Workflow）  
**推荐度**: ⭐⭐⭐⭐（4/5）  
**适用场景**: 公司已购买飞书高级套餐，不想维护自己的服务器  
**更新日期**: 2026-01-27

---

## 📋 方案概述

使用飞书官方提供的工作配方（Workflow），通过可视化配置实现 GitLab 集成。

### 优点

- ✅ **官方支持**：稳定可靠
- ✅ **无需编码**：可视化配置
- ✅ **无需维护**：飞书官方维护
- ✅ **功能完整**：中文、提交人信息完整

### 缺点

- ❌ **需要审批**：需要老板批准
- ⚠️ **可能付费**：取决于公司飞书套餐
- ⚠️ **自定义受限**：只能使用飞书提供的功能

---

## 🚀 快速部署（10 分钟）

### Step 1: 检查飞书套餐

#### 1.1 确认是否有工作配方功能

1. 登录飞书管理后台：https://www.feishu.cn/admin
2. 点击左侧菜单 "工作台" → "工作配方"
3. 查看是否可以访问

#### 1.2 如果没有权限

**需要申请开通**：
- 参考：[给老板的申请文档](../给老板的申请文档.md)
- 说明业务价值和投资回报

### Step 2: 创建工作配方

#### 2.1 进入工作配方

1. 登录飞书管理后台
2. 点击 "工作台" → "工作配方"
3. 点击 "创建配方"

#### 2.2 选择触发器

1. 搜索 "GitLab"
2. 选择 "GitLab - 代码推送时"
3. 点击 "下一步"

#### 2.3 配置 GitLab 连接

**需要的信息**：
- GitLab URL: `https://gitlab.huixuanjiasu.com`
- Access Token: 需要创建 GitLab Personal Access Token

**创建 Access Token**：
1. 登录 GitLab
2. 点击右上角头像 → Settings
3. 点击左侧 "Access Tokens"
4. 填写信息：
   - Name: `飞书工作配方`
   - Scopes: ✅ `api`
5. 点击 "Create personal access token"
6. 复制生成的 Token（只显示一次！）

**配置连接**：
1. 在飞书工作配方中粘贴 Token
2. 点击 "测试连接"
3. 确认连接成功

#### 2.4 选择项目

1. 选择要监听的 GitLab 项目
2. 例如：`grouptwogame/grouptowart_hb`
3. 点击 "下一步"

### Step 3: 配置动作

#### 3.1 添加动作

1. 点击 "添加动作"
2. 搜索 "发送消息"
3. 选择 "发送飞书消息"

#### 3.2 配置消息内容

**接收人**：
- 选择 "指定用户"
- 添加项目负责人（通过邮箱或姓名）

**消息类型**：
- 选择 "卡片消息"

**消息内容**：
```json
{
  "config": {
    "wide_screen_mode": true
  },
  "header": {
    "title": {
      "tag": "plain_text",
      "content": "【美术资源更新提醒】"
    },
    "template": "blue"
  },
  "elements": [
    {
      "tag": "div",
      "fields": [
        {
          "is_short": true,
          "text": {
            "tag": "lark_md",
            "content": "**项目**\n{{project_name}}"
          }
        },
        {
          "is_short": true,
          "text": {
            "tag": "lark_md",
            "content": "**提交人**\n{{user_name}}"
          }
        }
      ]
    },
    {
      "tag": "div",
      "text": {
        "tag": "lark_md",
        "content": "**提交信息**\n{{commit_message}}"
      }
    },
    {
      "tag": "action",
      "actions": [
        {
          "tag": "button",
          "text": {
            "tag": "plain_text",
            "content": "查看变更"
          },
          "url": "{{commit_url}}",
          "type": "primary"
        }
      ]
    }
  ]
}
```

**变量说明**：
- `{{project_name}}`: 项目名称
- `{{user_name}}`: 提交人姓名
- `{{commit_message}}`: 提交信息
- `{{commit_url}}`: 提交链接

#### 3.3 配置多人通知

如果需要通知多个人：

**方式 1：添加多个动作**
1. 点击 "添加动作"
2. 重复配置，选择不同的接收人

**方式 2：使用群组**
1. 创建飞书群组
2. 添加所有负责人
3. 发送消息到群组

### Step 4: 保存并启用

1. 点击 "保存"
2. 给配方命名：`GitLab 美术资源更新通知`
3. 点击 "启用"

### Step 5: 测试配方

#### 5.1 使用测试功能

1. 在配方详情页点击 "测试"
2. 选择一个历史提交
3. 点击 "运行测试"
4. 查看飞书是否收到通知

#### 5.2 提交代码测试

```bash
cd D:\HuiXuanJiaSu\I_IAA_Work
git add .
git commit -m "测试飞书工作配方通知"
git push
```

### Step 6: 查看结果

#### 飞书通知

```
【美术资源更新提醒】

项目: GroupTwoGame/groupTowArt_Hb
提交人: 王新来
提交信息: 更新角色动画资源，修复了跑步动画的bug

[查看变更]
```

#### 执行日志

1. 在配方详情页点击 "执行记录"
2. 查看每次执行的状态
3. 如果失败，查看错误信息

---

## 🔧 高级配置

### 配置条件触发

**只在特定分支触发**：

1. 在触发器配置中添加条件
2. 选择 "分支名称"
3. 输入：`master` 或 `main`

**只在特定文件变更时触发**：

1. 添加条件
2. 选择 "变更文件路径"
3. 输入：`assets/*` 或 `*.png`

### 配置通知规则

**根据项目路径选择接收人**：

1. 添加条件判断
2. 如果项目路径包含 "groupTowArt_Hb"
3. 发送给 wangxinlai@huixuanjiasu.com
4. 否则发送给其他人

### 配置消息模板

**自定义卡片样式**：

```json
{
  "header": {
    "template": "blue"  // 可选: blue, green, red, orange, purple
  }
}
```

**添加更多信息**：

```json
{
  "tag": "div",
  "text": {
    "tag": "lark_md",
    "content": "**分支**\n{{branch_name}}\n**变更文件数**\n{{changed_files_count}}"
  }
}
```

---

## 🐛 故障排查

### 问题 1：无法访问工作配方

**原因**：
- 公司飞书套餐不包含工作配方功能
- 或者没有权限

**解决方案**：
1. 联系飞书管理员
2. 申请开通工作配方功能
3. 参考：[给老板的申请文档](../给老板的申请文档.md)

---

### 问题 2：GitLab 连接失败

**原因**：
- Access Token 无效
- GitLab URL 错误
- 网络问题

**解决方案**：

1. **检查 Access Token**：
   - 是否已过期？
   - 是否有 `api` 权限？

2. **检查 GitLab URL**：
   - 是否可以访问？
   - 是否需要 VPN？

3. **重新创建 Token**：
   - 删除旧 Token
   - 创建新 Token
   - 更新配方配置

---

### 问题 3：没有收到通知

**排查步骤**：

1. **检查配方状态**：
   - 是否已启用？
   - 执行记录中是否有错误？

2. **检查触发条件**：
   - 是否满足触发条件？
   - 分支是否正确？

3. **检查接收人**：
   - 邮箱是否正确？
   - 用户是否在飞书中？

4. **查看执行日志**：
   - 在配方详情页查看执行记录
   - 查看错误信息

---

### 问题 4：通知延迟

**原因**：
- 飞书工作配方有执行队列
- 可能需要等待几秒到几分钟

**解决方案**：
- 这是正常现象
- 如果延迟超过 5 分钟，联系飞书客服

---

## 📋 维护指南

### 添加新项目

1. 进入配方详情页
2. 点击 "编辑"
3. 在触发器中添加新项目
4. 保存并测试

### 添加新负责人

1. 进入配方详情页
2. 点击 "编辑"
3. 在动作中添加新接收人
4. 或者添加新的发送消息动作
5. 保存并测试

### 修改消息模板

1. 进入配方详情页
2. 点击 "编辑"
3. 修改消息内容
4. 点击 "测试" 预览效果
5. 保存

### 查看执行记录

1. 进入配方详情页
2. 点击 "执行记录"
3. 查看每次执行的状态
4. 如果失败，查看错误信息

---

## 💰 成本说明

### 飞书套餐对比

| 套餐 | 工作配方 | 价格 |
|------|---------|------|
| 免费版 | ❌ 不支持 | 免费 |
| 专业版 | ✅ 支持 | ~¥19/人/月 |
| 企业版 | ✅ 支持 | ~¥39/人/月 |

**注意**：
- 价格可能变动，以飞书官网为准
- 可能有最低购买人数要求
- 可能有年付优惠

### 投资回报分析

**成本**：
- 假设 10 人团队
- 专业版：¥19 × 10 = ¥190/月
- 年成本：¥2,280

**收益**：
- 每天节省 50 分钟沟通时间
- 每月节省 18 小时
- 每年节省 216 小时 ≈ 27 个工作日
- 按人均工资 ¥500/天计算
- **每年节省成本：¥13,500**

**投资回报率**：
- ROI = (13,500 - 2,280) / 2,280 = 492%
- 回报周期 < 2 个月

---

## 🚀 与其他方案对比

### vs GitLab CI 方案

| 特性 | 飞书工作配方 | GitLab CI |
|------|------------|-----------|
| 部署难度 | 🟢 简单 | 🟡 中等 |
| 需要权限 | ✅ 需要审批 | ❌ 不需要 |
| 中文支持 | ✅ 完美 | ⚠️ 受限 |
| 提交人信息 | ✅ 完整 | ⚠️ 可能缺失 |
| 维护成本 | 🟢 低 | 🟡 中等 |
| 成本 | ⚠️ 可能付费 | 🟢 免费 |

### vs Webhook 方案

| 特性 | 飞书工作配方 | Webhook |
|------|------------|---------|
| 部署难度 | 🟢 简单 | 🟡 中等 |
| 需要权限 | ✅ 需要审批 | ✅ 需要管理员 |
| 中文支持 | ✅ 完美 | ✅ 完美 |
| 提交人信息 | ✅ 完整 | ✅ 完整 |
| 自定义能力 | ⚠️ 受限 | 🟢 强 |
| 维护成本 | 🟢 低 | 🟢 低 |
| 成本 | ⚠️ 可能付费 | 🟢 免费 |

---

## 📚 相关文档

- [方案对比与选择指南](../方案对比与选择指南.md) - 三种方案对比
- [GitLab CI 方案部署指南](./GitLab-CI方案部署指南.md) - 免费方案
- [Webhook 方案部署指南](./Webhook方案部署指南.md) - 推荐方案
- [给老板的申请文档](../给老板的申请文档.md) - 申请开通
- [飞书工作配方-GitLab集成配置指南](./飞书工作配方-GitLab集成配置指南.md) - 详细配置

---

## 🎉 总结

### 适用场景

- ✅ 公司已购买飞书高级套餐
- ✅ 不想维护自己的服务器
- ✅ 对自定义要求不高
- ✅ 希望使用官方支持的方案

### 不适用场景

- ❌ 公司使用免费版飞书
- ❌ 需要高度自定义
- ❌ 不想付费

### 推荐理由

1. **官方支持**：稳定可靠，无需担心维护
2. **无需编码**：可视化配置，降低技术门槛
3. **功能完整**：中文、提交人信息完整
4. **投资回报高**：ROI > 400%

### 申请建议

**如果公司还没有飞书工作配方**：
1. 准备申请文档：[给老板的申请文档](../给老板的申请文档.md)
2. 说明业务价值和投资回报
3. 强调官方支持和稳定性
4. 提供试用期建议（1-3 个月）

**如果申请被拒绝**：
- 使用 Webhook 方案（推荐）
- 或使用 GitLab CI 方案（备用）

---

**创建时间**: 2026-01-27  
**维护人**: 技术团队  
**版本**: v1.0
