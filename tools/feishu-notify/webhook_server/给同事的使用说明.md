# GitLab Webhook 飞书通知 - 使用说明

> 📦 这是一个完整的一键部署包，可以快速部署 GitLab 飞书通知系统

---

## 🎯 这是什么？

当你提交代码到 GitLab 时，项目负责人会自动收到飞书私聊通知，包含：
- 项目名称
- 提交人
- 提交信息
- 查看变更按钮

---

## 🚀 快速开始（3 步）

### 第 1 步：运行一键部署（5 分钟）

双击运行：
```
一键部署.bat
```

脚本会自动：
- ✅ 检查 Python 环境
- ✅ 安装依赖（Flask、requests）
- ✅ 获取你的服务器 IP
- ✅ 生成部署信息

### 第 2 步：配置项目负责人（2 分钟）

编辑文件：`config/owners.json`

```json
{
    "你的项目名": "你的邮箱@huixuanjiasu.com"
}
```

**示例**：
```json
{
    "Y_遇水发财": "zhangsan@huixuanjiasu.com",
    "N_奶奶的小农院": ["lisi@huixuanjiasu.com", "wangwu@huixuanjiasu.com"]
}
```

**匹配规则**：
- GitLab 项目路径：`grouptwogame/Y_遇水发财`
- 配置 key：`Y_遇水发财`
- 只要项目路径包含 key 即可匹配

### 第 3 步：配置 GitLab Webhook（2 分钟）

1. 打开你的 GitLab 项目
2. 进入 **Settings** → **Webhooks**
3. 填写配置（从 `部署信息.txt` 复制）：
   - **URL**: `http://你的IP:5000/gitlab-webhook`
   - **Secret Token**: 留空
   - **Trigger**: 勾选 `Push events`
   - **SSL verification**: 取消勾选
4. 点击 **Add webhook**
5. 点击 **Test** → **Push events** 测试

---

## 📁 文件说明

```
webhook_server/
├── 一键部署.bat              # 🔥 一键部署脚本
├── 检查环境.bat              # 环境检查工具
├── 配置向导.bat              # 配置向导
├── 启动Webhook服务器.bat     # 启动服务器
├── 测试Webhook.bat           # 测试工具
├── 部署信息.txt              # 自动生成的部署信息
├── 环境检查报告.txt          # 自动生成的检查报告
├── 给同事的使用说明.md       # 本文档
├── 快速部署指南.md           # 详细指南
└── README.md                 # 完整文档
```

---

## 🔧 常用操作

### 启动服务器

```
启动Webhook服务器.bat
```

**⚠️ 重要**：保持窗口打开，不要关闭！

### 测试功能

```
测试Webhook.bat
```

或提交代码测试：
```bash
git add .
git commit -m "测试通知"
git push
```

### 检查环境

```
检查环境.bat
```

会自动检查：
- Python 环境
- 依赖库
- 网络配置
- 防火墙规则

### 修改配置

编辑 `config/owners.json`，保存后服务器会自动重新加载。

---

## 🐛 常见问题

### 问题 1：收不到通知

**检查清单**：
1. ✅ Webhook 服务器是否正在运行？
2. ✅ GitLab Webhook 是否配置正确？
3. ✅ `owners.json` 是否配置了你的项目？
4. ✅ 邮箱是否在飞书中存在？

**解决方案**：
```
1. 运行 "检查环境.bat" 检查环境
2. 运行 "测试Webhook.bat" 测试功能
3. 查看服务器控制台日志
```

### 问题 2：服务器无法启动

**错误**：`ModuleNotFoundError: No module named 'flask'`

**解决**：
```
运行 "一键部署.bat" 自动安装依赖
```

### 问题 3：GitLab 无法连接到 Webhook

**错误**：`Connection refused` 或 `Timeout`

**可能原因**：
1. 服务器没有启动
2. 防火墙阻止了 5000 端口
3. IP 地址填写错误

**解决**：
1. 确认服务器正在运行
2. 运行 "检查环境.bat" 检查防火墙
3. 检查 `部署信息.txt` 中的 IP 地址

### 问题 4：提交人显示错误

**说明**：这是正常的，Git 提交者信息由本地 Git 配置决定。

**查看配置**：
```bash
git config user.name
git config user.email
```

**修改配置**：
```bash
git config user.name "你的名字"
git config user.email "你的邮箱@huixuanjiasu.com"
```

---

## 📞 需要帮助？

### 查看文档

- **快速开始**：`快速部署指南.md`
- **完整文档**：`README.md`
- **方案对比**：`../docs/GitLab-CI-vs-Webhook方案对比.md`

### 运行诊断工具

```
检查环境.bat
```

会生成详细的检查报告。

### 联系管理员

如果问题无法解决，请联系系统管理员，并提供：
1. `环境检查报告.txt`
2. 服务器控制台日志
3. GitLab Webhook 测试结果

---

## 🎉 完成！

部署完成后，每次提交代码到 GitLab，项目负责人都会收到飞书通知！

**优势**：
- ✅ 自动通知，不会错过重要更新
- ✅ 支持多人通知
- ✅ 中文完美支持
- ✅ 提交人信息完整

享受自动化通知带来的便利吧！🚀

---

**创建时间**: 2026-01-23  
**版本**: v1.0  
**维护**: 技术团队
