# GitLab Webhook 飞书通知 - 快速部署指南

## 🎯 5 分钟完成部署

### 第 1 步：启动服务器（1 分钟）

双击运行：
```
启动Webhook服务器.bat
```

看到以下信息表示启动成功：
```
========================================
  服务器信息
========================================
  监听地址: http://0.0.0.0:5000
  Webhook URL: http://你的服务器IP:5000/gitlab-webhook
  健康检查: http://你的服务器IP:5000/health
========================================
```

**⚠️ 重要**：
- 保持这个窗口打开，不要关闭
- 记下你的服务器 IP 地址（如 `192.168.1.100`）

### 第 2 步：配置 GitLab Webhook（2 分钟）

1. 打开你的 GitLab 项目页面
   - 例如：`https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb`

2. 点击左侧菜单：**Settings** → **Webhooks**

3. 填写 Webhook 配置：
   ```
   URL: http://你的服务器IP:5000/gitlab-webhook
   例如: http://192.168.1.100:5000/gitlab-webhook
   
   Secret Token: (留空)
   
   Trigger: ✅ Push events
   
   SSL verification: ❌ 取消勾选（如果是内网 HTTP）
   ```

4. 点击 **Add webhook** 按钮

5. 在 Webhooks 列表中，找到刚添加的 Webhook，点击 **Test** → **Push events**

6. 看到 **Hook executed successfully: HTTP 200** 表示成功！

### 第 3 步：测试通知（1 分钟）

1. 修改项目中的任意文件
2. 提交并推送到 GitLab：
   ```bash
   git add .
   git commit -m "测试 Webhook 通知"
   git push
   ```

3. 检查：
   - ✅ 服务器控制台有日志输出
   - ✅ 飞书收到通知
   - ✅ 提交人和提交信息正确显示

### 第 4 步：配置项目负责人（1 分钟）

编辑 `../config/owners.json`，添加你的项目配置：

```json
{
    "你的项目名": "你的邮箱@huixuanjiasu.com"
}
```

**匹配规则**：
- 项目路径：`grouptwogame/Y_遇水发财`
- 配置 key：`Y_遇水发财`（项目路径包含这个 key 即可）

**多人通知**：
```json
{
    "你的项目名": [
        "email1@huixuanjiasu.com",
        "email2@huixuanjiasu.com"
    ]
}
```

保存后，服务器会自动重新加载配置（无需重启）。

### 第 5 步：禁用旧的 GitLab CI 通知（可选）

如果你之前使用 GitLab CI 方案，现在可以禁用它：

编辑 `.gitlab-ci.yml`，注释掉 `notify` 任务：

```yaml
# notify:
#   stage: notify
#   script:
#     - ...
```

提交修改：
```bash
git add .gitlab-ci.yml
git commit -m "切换到 Webhook 通知方案"
git push
```

## ✅ 完成！

现在每次推送代码到 GitLab，项目负责人都会收到飞书通知，包含：
- ✅ 项目名称
- ✅ 提交人（正确显示，不会是 "Unknown User"）
- ✅ 提交信息（完整的中文信息，不会乱码）
- ✅ 查看变更按钮（直接跳转到 GitLab）

## 🔍 验证清单

- [ ] 服务器启动成功（控制台显示监听地址）
- [ ] GitLab Webhook 配置成功（测试返回 HTTP 200）
- [ ] 提交代码后飞书收到通知
- [ ] 通知中提交人显示正确
- [ ] 通知中提交信息显示正确（中文无乱码）
- [ ] `owners.json` 配置了你的项目

## 🐛 常见问题

### 问题 1：服务器启动失败

**错误信息**：`ModuleNotFoundError: No module named 'flask'`

**解决**：
```bash
pip install -r requirements.txt
```

### 问题 2：GitLab Webhook 测试失败

**错误信息**：`Connection refused` 或 `Timeout`

**可能原因**：
1. 服务器没有启动
2. 防火墙阻止了 5000 端口
3. IP 地址填写错误

**解决**：
1. 确认服务器正在运行
2. 检查防火墙设置，开放 5000 端口
3. 确认 IP 地址正确（可以在服务器上运行 `ipconfig` 查看）

### 问题 3：收不到飞书通知

**检查步骤**：
1. 查看服务器控制台，是否有错误日志
2. 检查 `owners.json` 配置是否正确
3. 检查邮箱是否在飞书中存在
4. 检查飞书应用权限（需要 `contact:user.email:readonly` 权限）

### 问题 4：提交人显示为其他人

**说明**：这是正常的，Git 提交者信息由本地 Git 配置决定。

**查看本地 Git 配置**：
```bash
git config user.name
git config user.email
```

**修改本地 Git 配置**：
```bash
git config user.name "你的名字"
git config user.email "你的邮箱@huixuanjiasu.com"
```

## 📞 需要帮助？

查看详细文档：
- `README.md` - 完整文档
- `../docs/关键经验-必读.md` - 关键经验和教训

## 🎉 恭喜！

你已经成功部署了 GitLab Webhook 飞书通知系统！

相比之前的 GitLab CI 方案，现在：
- ✅ 不再有中文乱码问题
- ✅ 提交人信息完整显示
- ✅ 更快、更稳定、更易维护

享受自动化通知带来的便利吧！ 🚀
