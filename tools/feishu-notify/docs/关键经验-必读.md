# 飞书通知系统 - 关键经验（必读）

> ⚠️ 修改代码前必须阅读此文档！  
> 💰 忽略这些经验会浪费时间和金钱！

---

## 🎉 最佳方案：Webhook（2026-01-23）

### 为什么选择 Webhook？

经过多次尝试，我们发现 **GitLab Webhook + Python Flask 服务器** 是最佳方案：

**优势**：
1. ✅ **完全避免 Windows 编码问题** - 不需要通过 GitLab CI 传递中文
2. ✅ **提交人信息完整** - 直接从 Webhook 数据获取，不会丢失
3. ✅ **更专业可靠** - GitLab 官方推荐的集成方式
4. ✅ **性能更好** - 不需要启动 GitLab Runner，响应更快
5. ✅ **更易维护** - 代码逻辑清晰，调试方便

**对比 GitLab CI 方案**：

| 特性 | GitLab CI 方案 | Webhook 方案 |
|------|---------------|-------------|
| 中文编码 | ❌ 经常乱码 | ✅ 完美支持 |
| 提交人信息 | ❌ 容易丢失 | ✅ 完整显示 |
| 部署复杂度 | 🟡 中等 | 🟢 简单 |
| 维护成本 | 🔴 高 | 🟢 低 |
| 调试难度 | 🔴 困难 | 🟢 容易 |
| 性能 | 🟡 中等 | 🟢 快速 |

**部署指南**：
- 查看 `../webhook_server/快速部署指南.md` - 5 分钟完成部署
- 查看 `../webhook_server/README.md` - 完整文档

**迁移建议**：
- 如果你正在使用 GitLab CI 方案，强烈建议迁移到 Webhook 方案
- 迁移过程简单，不会影响现有功能
- 迁移后可以禁用 GitLab CI 通知任务

---

## 🔥 血泪教训（GitLab CI 方案）

> ⚠️ 以下是 GitLab CI 方案的经验教训  
> 💡 建议使用 Webhook 方案，避免这些问题

### 教训 1：GitLab Runner 工作目录问题（2026-01-20/21）

**问题**：
- GitLab Runner 的工作目录是临时的：`C:\GitLab-Runner\builds\...`
- 每次任务都不一样
- 中文文件名会导致编码错误

**解决方案**：
```yaml
# .gitlab-ci.yml
notify:
  script:
    - Set-Location C:\GitLab-Runner  # ← 必须！
    - python notify.py
  variables:
    GIT_STRATEGY: none  # ← 必须！避免拉取代码
```

**代价**：
- 2026-01-21：忘记了这个问题，反复调试，浪费 2 美刀

**记住**：
- ✅ 脚本必须放在 `C:\GitLab-Runner\` 根目录
- ✅ 配置文件必须放在 `C:\GitLab-Runner\` 根目录
- ✅ 必须使用 `Set-Location C:\GitLab-Runner`
- ✅ 必须使用 `GIT_STRATEGY: none`

---

### 教训 2：环境变量丢失问题（2026-01-21）

**问题**：
- 使用 `GIT_STRATEGY: none` 后，环境变量变成"未知"
- 导致无法匹配项目路径

**解决方案**：
```yaml
# .gitlab-ci.yml
notify:
  script:
    - $env:CI_PROJECT_PATH = $env:CI_PROJECT_PATH      # ← 手动保留
    - $env:CI_COMMIT_MESSAGE = $env:CI_COMMIT_MESSAGE
    - $env:GITLAB_USER_NAME = $env:GITLAB_USER_NAME
    - $env:CI_COMMIT_SHA = $env:CI_COMMIT_SHA
    - $env:CI_PROJECT_URL = $env:CI_PROJECT_URL
    - Set-Location C:\GitLab-Runner
    - python notify.py
```

**记住**：
- ✅ 必须手动保留所有需要的环境变量
- ✅ 在 `Set-Location` 之前保留

---

### 教训 3：Emoji 编码问题（2026-01-21）

**问题**：
- Windows PowerShell 不支持 emoji
- 会导致脚本报错

**解决方案**：
```python
# 删除所有 emoji，使用纯文本
print("[成功]")  # ✅ 正确
print("✓ 成功")  # ❌ 错误（Windows 不支持）
```

**记住**：
- ✅ 不要在脚本中使用 emoji
- ✅ 使用纯文本标签：`[成功]`、`[错误]`、`[警告]`

---

## 📋 修改代码前的检查清单

### 必须检查的 5 个问题

```
□ 1. 上次是怎么解决的？
     → 查看 docs/修复方案.md
     → 查看 CHANGELOG.md

□ 2. 有没有特殊的环境限制？
     → GitLab Runner 工作目录
     → Windows 编码问题
     → 环境变量问题

□ 3. 修改会不会破坏之前的修复？
     → 是否保留了 Set-Location？
     → 是否保留了 GIT_STRATEGY: none？
     → 是否保留了环境变量？

□ 4. 有没有测试计划？
     → 本地测试
     → 生产环境测试
     → 回滚方案

□ 5. 有没有更新文档？
     → 更新 CHANGELOG.md
     → 更新部署指南
     → 更新此文档
```

---

## 🎯 部署流程（标准操作）

### Step 1: 本地测试

```bash
# 设置环境变量
set FEISHU_APP_ID=your_app_id
set FEISHU_APP_SECRET=your_app_secret
set CI_PROJECT_PATH=grouptwogame/测试文件
set GITLAB_USER_NAME=测试用户
set CI_COMMIT_MESSAGE=测试提交

# 运行脚本
cd Feishu_Notify_Setup\scripts
python notify_v3_auto_match.py
```

### Step 2: 部署到生产

```bash
# 复制文件到 GitLab Runner 目录
copy scripts\notify_v3_auto_match.py C:\GitLab-Runner\notify.py
copy config\owners.json C:\GitLab-Runner\owners.json

# 复制文件到公司工程
copy scripts\notify_v3_auto_match.py D:\HuiXuanJiaSu\I_IAA_Work\notify.py
copy config\owners.json D:\HuiXuanJiaSu\I_IAA_Work\owners.json
copy .gitlab-ci.yml D:\HuiXuanJiaSu\I_IAA_Work\.gitlab-ci.yml
```

### Step 3: 提交测试

```bash
cd D:\HuiXuanJiaSu\I_IAA_Work
git add .
git commit -m "更新通知脚本"
git push
```

### Step 4: 查看日志

1. 打开 GitLab 项目
2. 点击 CI/CD → Pipelines
3. 查看最新任务日志
4. 确认通知发送成功

---

## 🚨 常见错误

### 错误 1：找不到 owners.json

**原因**：
- 脚本不在 `C:\GitLab-Runner\` 目录运行
- 没有使用 `Set-Location C:\GitLab-Runner`

**解决**：
```yaml
script:
  - Set-Location C:\GitLab-Runner  # ← 必须加这行
  - python notify.py
```

---

### 错误 2：环境变量为"未知"

**原因**：
- 使用了 `GIT_STRATEGY: none`
- 没有手动保留环境变量

**解决**：
```yaml
script:
  - $env:CI_PROJECT_PATH = $env:CI_PROJECT_PATH  # ← 必须加这行
  - Set-Location C:\GitLab-Runner
  - python notify.py
```

---

### 错误 3：中文编码错误

**原因**：
- GitLab Runner 拉取了代码
- 中文文件名导致编码错误

**解决**：
```yaml
variables:
  GIT_STRATEGY: none  # ← 必须加这行
```

---

## 💰 成本提醒

### 每次调试的成本

| 操作 | Token 消耗 | 费用（美刀） |
|------|-----------|-------------|
| 一次完整对话 | ~50,000 | ~$0.10 |
| 反复调试 10 次 | ~500,000 | ~$1.00 |
| 忘记经验重来 | ~1,000,000 | ~$2.00 |

**教训**：
- 💰 2026-01-21：忘记 GitLab Runner 问题，浪费 $2.00
- 💡 阅读此文档：免费
- 🎯 遵循检查清单：省钱省时间

---

## 📚 相关文档

- [修复方案](./修复方案.md) - 详细的问题排查过程
- [v3.1 部署指南](./v3.1部署指南.md) - 最新版本部署
- [GitLab Runner 原理](../../knowledge-base/notes/20260122-GitLab-Runner工作原理通俗讲解.md)
- [CHANGELOG](../CHANGELOG.md) - 完整更新历史

---

## 🎓 经验总结

### 为什么会忘记？

1. **会话太长**：对话超过 50 条消息，AI 会"忘记"前面的内容
2. **没有文档**：经验没有记录下来
3. **没有检查清单**：修改代码前没有回顾

### 如何避免？

1. **记录经验**：每次解决问题后，立即写文档
2. **使用检查清单**：修改前必须检查
3. **定期回顾**：每周回顾一次关键经验
4. **自动化测试**：避免人为疏忽

---

## 🚀 推荐方案总结

### 新项目

**强烈推荐使用 Webhook 方案**：
1. 部署简单（5 分钟）
2. 功能完整（提交人、中文信息）
3. 易于维护（代码清晰）
4. 性能优秀（响应快速）

### 现有项目

**建议迁移到 Webhook 方案**：
1. 避免 Windows 编码问题
2. 避免环境变量丢失问题
3. 避免 GitLab Runner 工作目录问题
4. 降低维护成本

### 特殊情况

**如果必须使用 GitLab CI 方案**：
- 严格遵循本文档的检查清单
- 定期回顾关键经验
- 做好文档记录

---

**创建时间**: 2026-01-22  
**最后更新**: 2026-01-23（添加 Webhook 方案推荐）  
**维护人**: Kiro AI Assistant  
**重要性**: ⭐⭐⭐⭐⭐（最高）

---

## ⚠️ 最后提醒

**修改代码前，必须：**
1. ✅ 阅读此文档
2. ✅ 检查清单
3. ✅ 本地测试
4. ✅ 查看历史文档

**否则：**
- ❌ 浪费时间
- ❌ 浪费金钱
- ❌ 重复犯错

---

**记住：经验是用钱买来的，不要浪费！** 💰
