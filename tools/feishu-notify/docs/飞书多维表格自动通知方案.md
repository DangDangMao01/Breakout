# 飞书多维表格自动通知方案

## 📊 适用场景

### 场景 1：Bug 管理
- 测试在飞书多维表格中记录 Bug
- 系统自动通知对应负责人（美术/前端/后端）
- Bug 即将到期时自动提醒

### 场景 2：任务排期
- 策划在飞书多维表格中维护任务排期
- 任务即将开始/到期时自动提醒负责人
- 任务逾期时自动通知

## 🏗️ 表格结构设计

### Bug 管理表

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| Bug ID | 自动编号 | 唯一标识 | BUG-001 |
| Bug 标题 | 文本 | Bug 描述 | 角色动画播放异常 |
| Bug 类型 | 单选 | 美术/前端/后端/策划 | 美术 |
| 负责人 | 人员 | 飞书用户 | @王鑫来 |
| 优先级 | 单选 | 高/中/低 | 高 |
| 状态 | 单选 | 待修复/修复中/已修复/已验证 | 待修复 |
| 创建时间 | 日期 | 自动记录 | 2026-01-20 |
| 截止日期 | 日期 | 期望修复时间 | 2026-01-22 |
| 已通知 | 复选框 | 是否已发送通知 | ☐ |

### 任务排期表

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| 任务 ID | 自动编号 | 唯一标识 | TASK-001 |
| 任务名称 | 文本 | 任务描述 | 角色建模 |
| 负责人 | 人员 | 飞书用户 | @张三 |
| 开始日期 | 日期 | 任务开始时间 | 2026-01-20 |
| 截止日期 | 日期 | 任务结束时间 | 2026-01-25 |
| 状态 | 单选 | 未开始/进行中/已完成/延期 | 进行中 |
| 优先级 | 单选 | 高/中/低 | 高 |
| 已提醒 | 复选框 | 是否已发送提醒 | ☐ |

## 🔧 技术实现

### 1. 飞书 API 权限配置

需要在飞书开放平台配置以下权限：
- `bitable:app` - 读取多维表格
- `im:message` - 发送消息
- `contact:user` - 获取用户信息

### 2. Python 脚本逻辑

```python
# 伪代码示例
def check_bugs():
    # 1. 读取 Bug 表格
    bugs = feishu_api.get_bitable_records(table_id)
    
    # 2. 筛选未通知的新 Bug
    new_bugs = [b for b in bugs if not b['已通知']]
    
    # 3. 发送通知
    for bug in new_bugs:
        send_notification(
            user=bug['负责人'],
            message=f"新 Bug：{bug['Bug标题']}"
        )
        # 4. 更新通知状态
        update_record(bug['Bug ID'], {'已通知': True})

def check_deadlines():
    # 1. 读取任务表格
    tasks = feishu_api.get_bitable_records(table_id)
    
    # 2. 筛选即将到期的任务（3 天内）
    upcoming = [t for t in tasks 
                if days_until(t['截止日期']) <= 3 
                and not t['已提醒']]
    
    # 3. 发送提醒
    for task in upcoming:
        send_notification(
            user=task['负责人'],
            message=f"任务即将到期：{task['任务名称']}"
        )
        # 4. 更新提醒状态
        update_record(task['任务ID'], {'已提醒': True})
```

### 3. 定时执行

使用 Windows 任务计划程序或 GitLab CI 定时执行：

```yaml
# .gitlab-ci.yml
schedule_notify:
  stage: notify
  tags:
    - windows
  script:
    - python feishu_bitable_notify.py
  only:
    - schedules  # 只在定时任务时执行
```

## 📋 实施步骤

### 第一步：创建飞书多维表格

1. 在飞书中创建多维表格
2. 按照上面的结构设计字段
3. 录入几条测试数据

### 第二步：获取表格 ID

1. 打开多维表格
2. 复制浏览器地址栏中的 URL
3. 提取 `app_token` 和 `table_id`

示例 URL：
```
https://example.feishu.cn/base/bascnxxxxxx?table=tblxxxxxx
                              ↑ app_token  ↑ table_id
```

### 第三步：配置飞书应用权限

1. 登录飞书开放平台
2. 进入你的应用
3. 权限管理 → 添加权限：
   - `bitable:app` - 多维表格读写
   - `im:message` - 发送消息
   - `contact:user` - 获取用户信息
4. 发布应用版本

### 第四步：开发 Python 脚本

1. 使用飞书 API 读取表格数据
2. 实现通知逻辑
3. 本地测试

### 第五步：部署定时任务

1. 部署到 GitLab Runner
2. 配置定时执行（每 5 分钟或每小时）
3. 监控运行日志

## 🎯 通知场景设计

### Bug 通知

**场景 1：新 Bug 创建**
```
【Bug 通知】
🐛 Bug ID: BUG-001
📝 标题: 角色动画播放异常
🎨 类型: 美术
⏰ 截止日期: 2026-01-22
🔗 查看详情: [点击查看]
```

**场景 2：Bug 即将到期**
```
【Bug 到期提醒】
⚠️ 以下 Bug 即将到期，请及时处理：
• BUG-001: 角色动画播放异常（还剩 1 天）
• BUG-003: UI 显示错位（还剩 2 天）
```

### 任务提醒

**场景 1：任务即将开始**
```
【任务开始提醒】
📅 明天开始的任务：
• 角色建模（2026-01-21 ~ 2026-01-25）
请提前做好准备！
```

**场景 2：任务即将到期**
```
【任务到期提醒】
⏰ 以下任务即将到期：
• 角色建模（还剩 2 天）
• 场景设计（还剩 1 天）
请及时完成！
```

**场景 3：任务已逾期**
```
【任务逾期通知】
🚨 以下任务已逾期：
• 角色建模（逾期 1 天）
请尽快处理！
```

## 💰 价值评估

### 时间节省
- **Bug 通知**：每个 Bug 节省 2-3 分钟 × 每天 10 个 Bug = 20-30 分钟/天
- **任务提醒**：避免遗忘和延期，提高按时完成率

### 效率提升
- **测试侧**：不用手动通知，专注测试工作
- **开发侧**：及时收到 Bug，减少等待时间
- **策划侧**：自动提醒，避免任务遗漏

## 🔄 后续优化

### 短期优化
- [ ] 支持批量通知
- [ ] 添加通知统计面板
- [ ] 支持自定义通知规则

### 长期规划
- [ ] 集成到飞书群（群通知 + @相关人）
- [ ] 支持 Bug 自动分配
- [ ] 添加任务依赖关系提醒
- [ ] 生成周报/月报

---

**文档版本**：v1.0  
**创建日期**：2026-01-20  
**适用范围**：飞书多维表格 + 飞书机器人
