# 美术资源通知系统 v3.0 部署指南

> 版本: v3.0 - 自动匹配版  
> 更新时间: 2026-01-21  
> 核心改进: 智能匹配提交者，新增人员只需改配置

---

## 📋 部署清单

### 需要复制的文件
```
notify_v3_auto_match.py  → 公司工程根目录/notify.py
owners_example.json      → 公司工程根目录/owners.json（参考模板）
```

### 需要修改的文件
```
.gitlab-ci.yml           → 更新通知任务配置
owners.json              → 配置实际的人员邮箱
```

---

## 🚀 快速部署（3 步）

### Step 1: 复制脚本到公司工程

**在本地工程执行**：
```bash
# 假设公司工程路径是 D:\HuiXuanJiaSu\I_IAA_Work
cd D:\HuiXuanJiaSu\I_IAA_Work

# 复制脚本（重命名为 notify.py）
copy K:\Kiro_Work\Feishu_Notify_Setup\notify_v3_auto_match.py notify.py

# 复制配置模板
copy K:\Kiro_Work\Feishu_Notify_Setup\owners_example.json owners.json
```

---

### Step 2: 配置人员邮箱

**编辑 `owners.json`**：

```json
{
    "_comment": "美术资源负责人配置文件",
    "_说明": "GitLab用户名 → 飞书邮箱",
    
    "DangDangMao01": "zhaolida@huixuanjiasu.com",
    "WangXinlai": "wangxinlai@huixuanjiasu.com",
    
    "_备注": "新增人员只需添加一行",
    "新同事GitLab用户名": "email@huixuanjiasu.com"
}
```

**如何获取 GitLab 用户名？**
1. 打开 GitLab 项目的提交记录
2. 查看提交者名字（如截图中的 `DangDangMao01`）
3. 把这个名字作为 key，邮箱作为 value

---

### Step 3: 更新 .gitlab-ci.yml

**测试阶段配置**（先通知你）：

```yaml
stages:
  - notify

notify_art_update:
  stage: notify
  script:
    - python notify.py
  variables:
    GIT_STRATEGY: none
    TEST_MODE: "true"                              # 测试模式：启用
    TEST_EMAIL: "wangxinlai@huixuanjiasu.com"      # 测试邮箱：你的邮箱
  only:
    - main
  when: always
```

**正式上线配置**（通知实际负责人）：

```yaml
stages:
  - notify

notify_art_update:
  stage: notify
  script:
    - python notify.py
  variables:
    GIT_STRATEGY: none
    TEST_MODE: "false"    # 测试模式：关闭
  only:
    - main
  when: always
```

---

## 🧪 测试流程

### 测试步骤

1. **部署测试版**
   ```bash
   # 在公司工程
   git add notify.py owners.json .gitlab-ci.yml
   git commit -m "部署美术通知系统 v3.0（测试模式）"
   git push
   ```

2. **让美术同事提交测试**
   - 让"遇水发财"（DangDangMao01）提交一次
   - 你会收到飞书通知（不是她）
   - 检查通知内容是否正确

3. **查看 CI 日志**
   - 打开 GitLab → CI/CD → Pipelines
   - 查看 `notify_art_update` 任务日志
   - 确认匹配逻辑是否正确

4. **确认无误后上线**
   - 修改 `.gitlab-ci.yml`：`TEST_MODE: "false"`
   - 提交代码
   - 下次提交就会通知实际负责人

---

## 📊 日志解读

### 成功的日志示例

```
============================================================
>>> 美术资源通知系统 v3.0 - 自动匹配版
============================================================
📝 提交信息: 测试提交
👤 提交人: DangDangMao01
📁 项目路径: grouptwogame/grouptowart_hb
🔗 提交链接: https://gitlab.com/.../commit/abc123
🧪 测试模式: 启用
📧 测试邮箱: wangxinlai@huixuanjiasu.com
------------------------------------------------------------
✓ 成功加载 owners.json，共 5 个配置

🔍 正在查找 'DangDangMao01' 的邮箱配置...
🧪 测试模式：使用测试邮箱 wangxinlai@huixuanjiasu.com
------------------------------------------------------------

🔐 正在获取飞书访问令牌...
✓ 令牌获取成功

🔍 正在查找飞书用户 ID: wangxinlai@huixuanjiasu.com
✓ 找到用户 ID: ou_xxxxx
------------------------------------------------------------

📤 正在发送通知给 wangxinlai@huixuanjiasu.com...
✓ 卡片消息发送成功！
============================================================
✅ 通知发送完成
============================================================
```

### 常见错误及解决

#### 错误 1: 未找到邮箱配置
```
✗ 未找到 'DangDangMao01' 的邮箱配置
💡 提示: 请在 owners.json 中添加配置
   "DangDangMao01": "email@huixuanjiasu.com"
```

**解决**：在 `owners.json` 中添加这个用户的配置

---

#### 错误 2: 无法找到飞书用户
```
✗ 无法找到邮箱 xxx@huixuanjiasu.com 对应的飞书用户
💡 提示: 请检查邮箱是否正确，或用户是否在飞书中
```

**解决**：
1. 检查邮箱拼写是否正确
2. 确认这个邮箱在飞书中存在
3. 确认飞书应用有权限查询这个用户

---

#### 错误 3: 获取令牌失败
```
✗ 获取令牌失败，无法发送通知
```

**解决**：
1. 检查 GitLab CI/CD 变量中的 `FEISHU_APP_ID` 和 `FEISHU_APP_SECRET`
2. 确认飞书应用未过期
3. 确认网络连接正常

---

## 🔧 维护指南

### 新增美术人员

**场景**：新来一个美术同事，GitLab 用户名是 `NewArtist`

**操作**：
1. 编辑 `owners.json`
2. 添加一行：
   ```json
   "NewArtist": "newartist@huixuanjiasu.com"
   ```
3. 提交代码
4. 完成！

---

### 修改人员邮箱

**场景**：某个美术换了邮箱

**操作**：
1. 编辑 `owners.json`
2. 修改对应的邮箱
3. 提交代码
4. 完成！

---

### 新增项目

**场景**：新开了一个游戏项目

**操作**：
- 不需要任何操作！
- 只要这个项目的美术在 `owners.json` 里有配置就行
- 脚本会自动识别项目路径

---

## 📈 版本对比

| 功能 | v2.0 | v3.0 |
|------|------|------|
| 自动保存对话 | ✓ | ✓ |
| 匹配提交者 | ✗ 写死"测试文件" | ✓ 智能匹配 |
| 新增人员 | ✗ 需要改代码 | ✓ 只需改配置 |
| 模糊匹配 | ✗ | ✓ 支持 |
| 测试模式 | ✗ | ✓ 支持 |
| 详细日志 | ✗ | ✓ 支持 |

---

## 🎯 核心改进

### 1. 智能匹配算法

**支持三种匹配方式**：

```python
# 1. 精确匹配
"DangDangMao01" → "DangDangMao01"

# 2. 包含匹配（去掉项目前缀）
"DangDangMao01" → "Y_遇水发财"（如果包含"遇水发财"）

# 3. 反向包含
"遇水发财" → "DangDangMao01"（如果用户名包含"遇水发财"）
```

**好处**：
- 兼容性强
- 不需要精确配置
- 支持中文昵称

---

### 2. 配置文件驱动

**v2.0 的问题**：
```python
# 写死在代码里
test_email = owners.get("测试文件", "")
```

**v3.0 的改进**：
```python
# 自动匹配
owner_email = find_owner_email(user_name, owners)
```

**好处**：
- 新增人员不需要改代码
- 配置和代码分离
- 易于维护

---

### 3. 测试模式

**v2.0 的问题**：
- 测试时会通知到实际负责人
- 容易打扰别人

**v3.0 的改进**：
```yaml
variables:
  TEST_MODE: "true"
  TEST_EMAIL: "wangxinlai@huixuanjiasu.com"
```

**好处**：
- 测试时只通知你
- 确认无误后再上线
- 不打扰其他人

---

## 🐛 故障排查

### 问题：通知没发送

**排查步骤**：

1. **检查 CI 任务是否运行**
   ```
   GitLab → CI/CD → Pipelines → 查看最新任务
   ```

2. **查看任务日志**
   ```
   点击 notify_art_update 任务 → 查看日志
   ```

3. **检查环境变量**
   ```
   GitLab → Settings → CI/CD → Variables
   确认 FEISHU_APP_ID 和 FEISHU_APP_SECRET 存在
   ```

4. **检查 owners.json**
   ```
   确认提交者的用户名在配置中
   确认邮箱拼写正确
   ```

---

### 问题：匹配不到用户

**可能原因**：
1. GitLab 用户名和 owners.json 中的 key 不匹配
2. owners.json 格式错误（JSON 语法错误）

**解决方法**：
1. 查看 CI 日志中的"提交人"字段
2. 把这个名字添加到 owners.json
3. 确保 JSON 格式正确（可以用在线工具验证）

---

## 📚 相关文档

- [飞书应用创建指南](./飞书应用创建指南.md)
- [使用说明](./使用说明.md)
- [功能价值说明](./功能价值说明.md)

---

## 🎉 完成检查清单

部署完成后，确认以下事项：

- [ ] 脚本已复制到公司工程
- [ ] owners.json 已配置实际邮箱
- [ ] .gitlab-ci.yml 已更新
- [ ] 测试模式已启用（TEST_MODE: "true"）
- [ ] 测试邮箱已设置为你的邮箱
- [ ] 代码已提交并推送
- [ ] 让美术同事提交测试
- [ ] 你收到了测试通知
- [ ] CI 日志显示匹配正确
- [ ] 关闭测试模式（TEST_MODE: "false"）
- [ ] 再次提交代码
- [ ] 正式上线完成！

---

**部署时间**: 约 10 分钟  
**维护成本**: 新增人员只需 1 分钟  
**稳定性**: 已在本地测试通过

有问题随时找我！🚀
