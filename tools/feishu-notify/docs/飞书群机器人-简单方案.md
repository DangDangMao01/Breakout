# 飞书群机器人 + GitLab Webhook - 简单方案

> 日期: 2026-01-22  
> 优势: **不需要申请**，5 分钟配置完成  
> 适合: 快速上手，简单场景

---

## 🎯 方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **飞书群机器人** | ✅ 不需要申请<br>✅ 5分钟配置<br>✅ 简单易用 | ❌ 只能发群消息<br>❌ 功能相对简单 | ⭐⭐⭐⭐⭐ |
| 飞书机器人助手 | ✅ 功能强大<br>✅ 可视化配置 | ❌ 需要申请<br>❌ 审批流程 | ⭐⭐⭐ |
| GitLab CI 脚本 | ✅ 灵活定制<br>✅ 可发私聊 | ❌ 需要写代码<br>❌ 维护成本高 | ⭐⭐⭐⭐ |

**推荐**：先用**飞书群机器人**，简单快速！

---

## 📋 配置步骤（5 分钟）

### Step 1: 创建飞书群（1 分钟）

1. **打开飞书**
2. **创建新群组**
   - 点击"+"→"创建群组"
   - 群名称：`美术资源通知群`
   - 添加成员：项目相关人员

3. **或使用现有群组**
   - 如果已有项目群，直接使用

---

### Step 2: 添加群机器人（2 分钟）

1. **打开群设置**
   - 点击群名称
   - 点击"设置"

2. **添加机器人**
   - 点击"群机器人"
   - 点击"添加机器人"
   - 选择"自定义机器人"

3. **配置机器人**
   - 名称：`GitLab 通知`
   - 描述：`自动通知美术资源提交`
   - 点击"添加"

4. **复制 Webhook 地址**
   ```
   https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx
   ```
   ⚠️ **重要**：保存好这个地址，后面要用！

---

### Step 3: 配置 GitLab Webhook（2 分钟）

1. **打开 GitLab 项目**
   - 进入你的项目：`GroupTwoGame/groupTowArt_Hb`

2. **进入 Webhook 设置**
   - 左侧菜单 → Settings（设置）
   - Webhooks

3. **添加 Webhook**
   - URL：粘贴刚才复制的飞书 Webhook 地址
   - Trigger（触发器）：
     - ✅ Push events（代码推送）
     - 分支：`master` 或 `main`
   - 点击"Add webhook"

---

### Step 4: 测试（1 分钟）

1. **提交测试代码**
   ```bash
   echo "test" > test.txt
   git add test.txt
   git commit -m "测试飞书通知"
   git push origin master
   ```

2. **查看群消息**
   - 等待 5-10 秒
   - 群里应该收到通知

---

## 🎨 消息格式

### GitLab 默认消息格式

GitLab 会自动发送这样的消息：

```
[GroupTwoGame/groupTowArt_Hb] 王新来 pushed to master

Commit: 测试飞书通知
Author: 王新来
URL: https://gitlab.com/...
```

---

### 自定义消息格式（可选）

如果你想要更漂亮的消息格式，需要：

**方案 A：使用中间服务**
- 搭建一个简单的 Web 服务
- 接收 GitLab Webhook
- 转换格式后发送到飞书

**方案 B：继续使用 GitLab CI 脚本**
- 保留我们之前的 Python 脚本
- 修改为发送到群机器人 Webhook
- 可以自定义消息格式

---

## 🔧 方案 B 详细步骤（推荐）

### 修改现有脚本发送到群机器人

1. **修改 notify.py**

```python
import os
import json
import requests

# 飞书群机器人 Webhook 地址
WEBHOOK_URL = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx"

def send_to_feishu_group(project_path, user_name, commit_message, commit_url):
    """发送消息到飞书群机器人"""
    
    # 构建卡片消息
    card = {
        "msg_type": "interactive",
        "card": {
            "header": {
                "title": {
                    "tag": "plain_text",
                    "content": "美术资源更新提醒"
                },
                "template": "blue"
            },
            "elements": [
                {
                    "tag": "div",
                    "fields": [
                        {
                            "is_short": True,
                            "text": {
                                "tag": "lark_md",
                                "content": f"**项目**\\n{project_path}"
                            }
                        },
                        {
                            "is_short": True,
                            "text": {
                                "tag": "lark_md",
                                "content": f"**提交人**\\n{user_name}"
                            }
                        }
                    ]
                },
                {
                    "tag": "div",
                    "text": {
                        "tag": "lark_md",
                        "content": f"**提交信息**\\n{commit_message}"
                    }
                },
                {
                    "tag": "action",
                    "actions": [
                        {
                            "tag": "button",
                            "text": {
                                "tag": "plain_text",
                                "content": "查看变更"
                            },
                            "url": commit_url,
                            "type": "primary"
                        }
                    ]
                },
                {
                    "tag": "note",
                    "elements": [
                        {
                            "tag": "plain_text",
                            "content": "请及时拉取最新资源！"
                        }
                    ]
                }
            ]
        }
    }
    
    try:
        response = requests.post(WEBHOOK_URL, json=card)
        if response.status_code == 200:
            print("[成功] 消息发送成功")
            return True
        else:
            print(f"[错误] 发送失败: {response.text}")
            return False
    except Exception as e:
        print(f"[错误] 发送异常: {e}")
        return False

def main():
    print("=" * 60)
    print(">>> 飞书群机器人通知系统")
    print("=" * 60)
    
    # 从环境变量获取提交信息
    commit_message = os.environ.get('CI_COMMIT_MESSAGE', '未知提交')
    user_name = os.environ.get('GITLAB_USER_NAME', '未知用户')
    project_path = os.environ.get('CI_PROJECT_PATH', '未知项目')
    commit_sha = os.environ.get('CI_COMMIT_SHA', '')
    commit_url = os.environ.get('CI_PROJECT_URL', '') + '/-/commit/' + commit_sha
    
    print(f"[提交信息] {commit_message}")
    print(f"[提交人] {user_name}")
    print(f"[项目路径] {project_path}")
    print(f"[提交链接] {commit_url}")
    print("-" * 60)
    
    # 发送到飞书群
    send_to_feishu_group(project_path, user_name, commit_message, commit_url)
    
    print("=" * 60)

if __name__ == "__main__":
    main()
```

2. **修改 .gitlab-ci.yml**

```yaml
stages:
  - notify

notify_art_update:
  stage: notify
  tags:
    - windows
  variables:
    GIT_STRATEGY: none
    PYTHONIOENCODING: "utf-8"
  script:
    - Set-Location C:\GitLab-Runner
    - $env:CI_PROJECT_PATH = $env:CI_PROJECT_PATH
    - $env:CI_COMMIT_MESSAGE = $env:CI_COMMIT_MESSAGE
    - $env:GITLAB_USER_NAME = $env:GITLAB_USER_NAME
    - $env:CI_COMMIT_SHA = $env:CI_COMMIT_SHA
    - $env:CI_PROJECT_URL = $env:CI_PROJECT_URL
    - python notify.py
  only:
    changes:
      - "**/*"
  allow_failure: true
```

3. **部署到 GitLab Runner**

```powershell
# 修改脚本中的 Webhook 地址
# 然后复制到 GitLab Runner
copy notify.py C:\GitLab-Runner\notify.py
```

---

## ✅ 优势总结

### 飞书群机器人方案

**优点**：
- ✅ **不需要申请**：立即可用
- ✅ **配置简单**：5 分钟完成
- ✅ **群组通知**：所有人都能看到
- ✅ **无需审批**：不需要等待
- ✅ **稳定可靠**：飞书官方支持

**缺点**：
- ❌ 只能发群消息（不能发私聊）
- ❌ 不能根据项目分配不同负责人
- ❌ 功能相对简单

**适合场景**：
- ✅ 团队协作项目
- ✅ 需要快速上手
- ✅ 所有人都需要知道提交信息
- ✅ 不需要复杂的分配逻辑

---

## 🎯 推荐方案

### 方案选择建议

**如果你的需求是**：
1. 快速上手 → **飞书群机器人**（推荐）
2. 需要私聊通知 → GitLab CI 脚本
3. 需要复杂逻辑 → 飞书机器人助手（需要申请）

**我的建议**：
1. **今天**：使用飞书群机器人（5 分钟配置）
2. **本周**：优化消息格式（使用 GitLab CI + 群机器人）
3. **下周**：如果需要更多功能，再申请飞书机器人助手

---

## 📝 配置清单

### 快速配置清单

```
□ 创建飞书群组（或使用现有群）
□ 添加群机器人
□ 复制 Webhook 地址
□ 在 GitLab 配置 Webhook
□ 测试提交
□ 确认收到通知
```

**预计时间**：5 分钟

---

## 🔗 相关链接

- [飞书群机器人官方文档](https://open.feishu.cn/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN)
- [GitLab Webhook 文档](https://docs.gitlab.com/ee/user/project/integrations/webhooks.html)

---

## 💡 小贴士

1. **Webhook 地址保密**
   - 不要泄露 Webhook 地址
   - 任何人有这个地址都能发消息到群里

2. **测试优先**
   - 先在测试群测试
   - 确认无误后再用到正式群

3. **消息频率**
   - 如果提交太频繁，考虑只监听主分支
   - 或者设置消息合并

4. **后续优化**
   - 可以结合 GitLab CI 脚本
   - 自定义更漂亮的消息格式
   - 添加更多信息（文件列表、变更统计等）

---

**现在就可以开始配置了！** 🚀

只需要 5 分钟，不需要申请，立即可用！
