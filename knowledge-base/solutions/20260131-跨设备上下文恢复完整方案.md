---
date: 2026-01-31
time: "10:00"
location: "公司"
source_project: "K_Kiro_Work"
tags: [cross-device, session-mechanism, long-term-memory, context-recovery, steering-optimization]
value_score: 10
---

# 跨设备上下文恢复完整方案

**问题**: Kiro 在跨设备工作时，上下文断裂和记忆丢失  
**目标**: 让 Kiro 有"长期记忆"，支持跨设备无缝工作  
**状态**: ✅ 设计完成，待测试

---

## 🔍 问题分析

### 触发场景

**用户**: "我们昨晚接近凌晨修改了下这个项目框架，你不记得了？"

**Kiro 的错误**:
- ❌ 只读取了 `20260130-今日对话总结.md`（下午的工作）
- ❌ 没有检查 Git 历史（凌晨的提交）
- ❌ 没有检查是否有多个工作时段
- ❌ 假设"昨天"只有一个工作时段

### 根本原因

**问题 1: 时间粒度太粗**
- 当前：一天一个总结文件
- 问题：无法区分"下午在公司"和"凌晨在家"
- 结果：跨设备工作时，上下文丢失

**问题 2: 没有工作会话（Session）概念**
- 当前：只有"今日总结"
- 问题：一天可能有多个工作会话（公司 → 家里 → 公司）
- 结果：无法追踪每个会话的工作内容

**问题 3: Git 历史没有被充分利用**
- 当前：只读取总结文档
- 问题：Git 提交记录包含了完整的工作历史
- 结果：漏掉了没有写入总结的工作

---

## 💡 解决方案：工作会话（Session）机制

### 核心思路

**从"日总结"升级到"会话总结"**

```
旧模式（有问题）：
20260130-今日对话总结.md
  ↓
包含了下午和凌晨的工作，但无法区分

新模式（解决方案）：
20260130-Session-1-公司-下午.md（14:30-18:00）
20260131-Session-2-家里-凌晨.md（00:00-02:00）
20260131-Session-3-公司-早上.md（09:00-现在）
```

### 详细设计

#### 1. 会话文件命名规范

```
格式：YYYYMMDD-Session-N-地点-时段.md

示例：
- 20260130-Session-1-公司-下午.md
- 20260131-Session-2-家里-凌晨.md
- 20260131-Session-3-公司-早上.md
```

#### 2. 会话元数据

```yaml
---
session_id: "20260131-S3"
date: 2026-01-31
start_time: "09:00"
end_time: "进行中"
location: "公司"
device: "公司的设备"
previous_session: "20260131-S2"
next_session: null
tags: [cross-device, session-mechanism]
value_score: 10
---
```

**关键字段**:
- `session_id`: 会话唯一标识（YYYYMMDD-SN）
- `start_time` / `end_time`: 会话时间范围
- `location`: 工作地点（公司/家里）
- `device`: 设备标识
- `previous_session` / `next_session`: 会话链

#### 3. 会话索引文件

**文件**: `knowledge-base/notes/SESSION-INDEX.md`

**功能**:
- 记录所有工作会话
- 提供快速查询接口（按日期、地点、主题）
- 追踪会话链（previous_session, next_session）

**示例**:
```markdown
## 2026-01-31

| Session ID | 时间 | 地点 | 主要工作 | 文件 |
|-----------|------|------|---------|------|
| 20260131-S3 | 09:00-现在 | 公司 | 跨设备上下文恢复方案 | 20260131-Session-3-公司-早上.md |
| 20260131-S2 | 00:00-02:00 | 家里 | 创建测试框架 | 20260131-Session-2-家里-凌晨.md |
```

---

## 🔧 Steering 规则优化

### 优化 1: "昨天做了什么"的处理

**旧流程**:
```
用户: "昨天做了什么"
  ↓
读取 YYYYMMDD-今日对话总结.md
  ↓
回答（可能遗漏凌晨的工作）
```

**新流程**:
```
用户: "昨天做了什么"
  ↓
1. 读取 SESSION-INDEX.md
2. 查找昨天的所有会话
3. 检查 Git 历史（git log --since="昨天"）
4. 对比会话记录和 Git 历史
5. 如果有遗漏，补充说明
6. 按时间顺序汇总回答
```

**示例回答**:
```
昨天（2026-01-30）你有 1 个工作会话：

**会话 1: 公司，下午（14:30-18:00）**
- Clawdbot / Claude-Mem 技术调研
- AI 长期记忆完整对比分析
- Steering 规则优化
- 时间地点记录优化
- 反幻觉规则
- DevBrain-App 战略决策

[检查 Git 历史...]
⚠️ 发现遗漏：昨晚凌晨（00:00-02:00）在家里还有工作：
- 创建测试框架
- 完善 .gitignore

让我补充这个会话记录...
```

### 优化 2: "昨晚做了什么"的处理

**新流程**:
```
用户: "昨晚做了什么"
  ↓
1. 读取 SESSION-INDEX.md
2. 查找昨晚的会话（时间 >= 18:00 或次日 < 06:00）
3. 读取会话内容
4. 回答
```

**时间判断逻辑**:
- "昨晚" = 昨天 18:00 - 今天 06:00
- 例如：2026-01-30 18:00 - 2026-01-31 06:00

### 优化 3: "继续开发"的处理

**旧流程**:
```
用户: "继续开发"
  ↓
读取 SESSION-STATE.md + 今日总结
  ↓
提供上下文
```

**新流程**:
```
用户: "继续开发"
  ↓
1. 读取 SESSION-INDEX.md
2. 查找最新的会话（按 session_id 排序）
3. 读取最新会话的内容
4. 检查 Git 最新提交（git log -5）
5. 检查 Git diff（git diff HEAD~1）
6. 汇总上下文，提供完整信息
```

### 优化 4: Git 历史的利用

**新增检查**:
```
每次回答"昨天做了什么"时：
1. 读取会话记录
2. 检查 Git 历史（git log --since="昨天"）
3. 对比两者
4. 如果有遗漏，补充说明
```

**Git 命令**:
```bash
# 查看昨天的提交
git log --since="yesterday" --oneline

# 查看昨天的详细提交
git log --since="yesterday" --stat

# 查看特定时间段的提交
git log --since="2026-01-30 18:00" --until="2026-01-31 06:00" --oneline
```

---

## 📋 实施步骤

### Step 1: 创建会话索引 ✅

**文件**: `knowledge-base/notes/SESSION-INDEX.md`

**状态**: 已完成

### Step 2: 创建历史会话记录 ✅

**已创建**:
- `20260130-Session-1-公司-下午.md`（昨天下午）
- `20260131-Session-2-家里-凌晨.md`（昨晚凌晨）
- `20260131-Session-3-公司-早上.md`（今天早上）

**状态**: 已完成

### Step 3: 优化 Steering 规则 ✅

**已更新**:
- `.kiro/steering/auto-kb-sync.md`（时间关键词处理 + 会话支持）
- `.kiro/steering/kb-link.md`（待更新）

**状态**: 部分完成

### Step 4: 创建 Hook（待做）

**Hook 1: 会话开始**
- 触发：用户开始新的工作会话
- 动作：创建新会话文件，更新会话索引

**Hook 2: 会话结束**
- 触发：用户结束工作会话
- 动作：更新会话文件，更新会话索引

**状态**: 待实施

### Step 5: 测试跨设备上下文恢复（待做）

**测试场景**:
1. 在公司工作 → 提交 Git → 回家
2. 在家里拉取 Git → 对 Kiro 说"今天做了什么"
3. 验证 Kiro 是否能正确回答公司的工作

**状态**: 待测试

---

## 💡 核心洞察

### 1. "长期记忆"的本质

**不是技术问题，而是组织问题**

**当前状态**: 信息都在，但组织方式不对
- ✅ Git 历史记录了所有变更
- ✅ 总结文档记录了工作内容
- ❌ 但无法快速定位"昨晚做了什么"

**解决方案**: 工作会话机制
- ✅ 按会话组织信息（时间 + 地点）
- ✅ 会话索引提供快速查询
- ✅ 会话链追踪工作流程

### 2. 跨设备工作的挑战

**挑战 1: 上下文断裂**
- 公司 → 家里：Kiro 不知道公司做了什么
- 家里 → 公司：Kiro 不知道家里做了什么

**解决方案**: 会话索引 + Git 同步
- ✅ 会话索引记录所有工作
- ✅ Git 同步保证数据一致
- ✅ Kiro 读取索引恢复上下文

**挑战 2: 时间粒度**
- 一天可能有多个工作时段
- 无法区分"下午"和"凌晨"

**解决方案**: 会话机制
- ✅ 每个工作时段一个会话
- ✅ 会话元数据记录时间和地点
- ✅ 会话链追踪工作流程

### 3. AI 的"记忆" vs 人类的记忆

**人类的记忆**:
- ✅ 记得"什么时候做的"（下午/晚上）
- ✅ 记得"在哪里做的"（公司/家里）
- ✅ 能根据时间和地点推理上下文

**AI 的"记忆"（当前）**:
- ❌ 只能读取文档
- ❌ 无法推理时间和地点
- ❌ 容易混淆不同时段的工作

**AI 的"记忆"（优化后）**:
- ✅ 读取会话索引
- ✅ 根据时间和地点查询
- ✅ 追踪会话链恢复上下文
- ✅ 检查 Git 历史补充遗漏

---

## 🚀 下一步行动

### 🔴 最高优先级

1. **完成 Steering 规则优化**
   - [ ] 更新 `kb-link.md`（会话支持）
   - [ ] 测试时间关键词触发
   - [ ] 测试"继续"关键词

2. **测试跨设备上下文恢复**
   - [ ] 在家里测试"今天做了什么"
   - [ ] 在家里测试"昨晚做了什么"
   - [ ] 在家里测试"继续开发"
   - [ ] 验证会话链是否正确

### 🟡 中优先级

3. **创建 Hook: 会话管理**
   - [ ] Hook: 会话开始（创建新会话文件）
   - [ ] Hook: 会话结束（更新会话索引）
   - [ ] 自动检测会话切换（地点变化）

4. **完善会话机制**
   - [ ] 自动关联 Git 提交到会话
   - [ ] 自动生成会话摘要
   - [ ] 会话统计和分析

---

## 📊 预期效果

### 效果 1: 跨设备无缝工作

**场景**:
```
公司（下午）：
你: "今天做了什么"
Kiro: "今天早上你在公司完成了 XXX"

家里（晚上）：
你: "今天做了什么"
Kiro: "今天你有 2 个工作会话：
  1. 公司，早上（09:00-12:00）：XXX
  2. 公司，下午（14:00-18:00）：XXX"
```

### 效果 2: 准确的时间记忆

**场景**:
```
你: "昨晚做了什么"
Kiro: "昨晚（2026-01-30 00:00-02:00）你在家里：
  - 创建测试框架
  - 完善 .gitignore"
```

### 效果 3: 完整的上下文恢复

**场景**:
```
你: "继续开发"
Kiro: "让我读取最新的会话..."
[读取 SESSION-INDEX.md]
[读取最新会话文件]
[检查 Git 历史]
"确认：你在开发跨设备上下文恢复方案。

根据进度，建议接下来：
1. 测试跨设备上下文恢复
2. 创建会话管理 Hook
3. 完善会话机制"
```

---

## 🎯 成功标准

### 标准 1: 零上下文丢失

**测试**:
- 在公司工作 → 回家 → 对 Kiro 说"今天做了什么"
- Kiro 能准确回答公司的工作内容

**通过条件**: 100% 准确

### 标准 2: 准确的时间记忆

**测试**:
- 对 Kiro 说"昨晚做了什么"
- Kiro 能准确回答昨晚的工作内容（不混淆下午和凌晨）

**通过条件**: 100% 准确

### 标准 3: Git 历史补充

**测试**:
- 有 Git 提交但没有会话记录
- Kiro 能检测到遗漏并补充说明

**通过条件**: 100% 检测率

---

## 📚 相关文档

**会话记录**:
- `knowledge-base/notes/SESSION-INDEX.md`（会话索引）
- `knowledge-base/notes/20260130-Session-1-公司-下午.md`（昨天下午）
- `knowledge-base/notes/20260131-Session-2-家里-凌晨.md`（昨晚凌晨）
- `knowledge-base/notes/20260131-Session-3-公司-早上.md`（今天早上）

**Steering 规则**:
- `.kiro/steering/auto-kb-sync.md`（已更新）
- `.kiro/steering/kb-link.md`（待更新）

**相关方案**:
- `knowledge-base/solutions/20260130-时间地点记录优化方案.md`
- `knowledge-base/solutions/20260130-Clawdbot超长记忆上下文技术调研报告.md`
- `knowledge-base/solutions/20260130-AI长期记忆完整对比分析报告.md`

---

**创建时间**: 2026-01-31 10:00  
**地点**: 公司  
**意义**: 解决跨设备上下文断裂问题，让 Kiro 有"长期记忆"
