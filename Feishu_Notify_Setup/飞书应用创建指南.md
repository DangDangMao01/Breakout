# é£ä¹¦åº”ç”¨åˆ›å»ºå’Œé…ç½®æŒ‡å—

## ä¸€ã€åˆ›å»ºé£ä¹¦ä¼ä¸šè‡ªå»ºåº”ç”¨

### æ­¥éª¤ 1: ç™»å½•é£ä¹¦å¼€æ”¾å¹³å°

1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: **https://open.feishu.cn**
2. ä½¿ç”¨å…¬å¸é£ä¹¦è´¦å·ç™»å½•
3. å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆåˆ›å»ºå¼€å‘è€…è´¦å·

### æ­¥éª¤ 2: åˆ›å»ºåº”ç”¨

1. ç‚¹å‡»å³ä¸Šè§’ **"åˆ›å»ºåº”ç”¨"** æˆ– **"åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨"**
2. å¡«å†™åº”ç”¨ä¿¡æ¯ï¼š
   - **åº”ç”¨åç§°**: `ç¾æœ¯èµ„æºæ›´æ–°é€šçŸ¥` æˆ– `GitLab é€šçŸ¥æœºå™¨äºº`
   - **åº”ç”¨æè¿°**: `è‡ªåŠ¨é€šçŸ¥ç¾æœ¯èµ„æºå˜æ›´`
   - **åº”ç”¨å›¾æ ‡**: ä¸Šä¼ ä¸€ä¸ªå›¾æ ‡ï¼ˆå¯é€‰ï¼‰
3. ç‚¹å‡» **"åˆ›å»º"**

### æ­¥éª¤ 3: è·å–å‡­è¯

åˆ›å»ºæˆåŠŸåï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ°åº”ç”¨è¯¦æƒ…é¡µï¼š

1. å·¦ä¾§èœå•ç‚¹å‡» **"å‡­è¯ä¸åŸºç¡€ä¿¡æ¯"**
2. ä½ ä¼šçœ‹åˆ°ï¼š
   ```
   App ID: cli_a5xxxxxxxxxxxxxx
   App Secret: xxxxxxxxxxxxxxxxxxxxxxxx
   ```
3. **å¤åˆ¶è¿™ä¸¤ä¸ªå€¼**ï¼Œç¨åä¼šç”¨åˆ°

**âš ï¸ é‡è¦**: App Secret åªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿å­˜ï¼

---

## äºŒã€é…ç½®åº”ç”¨æƒé™

### å¿…éœ€æƒé™åˆ—è¡¨

| æƒé™åç§° | æƒé™ä»£ç  | ç”¨é€” |
|---------|---------|------|
| è·å–ç”¨æˆ·é‚®ç®±ä¿¡æ¯ | `contact:user.email:readonly` | é€šè¿‡é‚®ç®±æŸ¥æ‰¾ç”¨æˆ· |
| è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ | `contact:user:readonly` | è·å–ç”¨æˆ· ID |
| å‘é€æ¶ˆæ¯ | `im:message` | å‘é€ç§èŠé€šçŸ¥ |

### é…ç½®æ­¥éª¤

1. å·¦ä¾§èœå•ç‚¹å‡» **"æƒé™ç®¡ç†"**
2. ç‚¹å‡» **"æ·»åŠ æƒé™"**
3. æœç´¢å¹¶å‹¾é€‰ä»¥ä¸‹æƒé™ï¼š
   - **é€šè®¯å½•** â†’ `è·å–ç”¨æˆ·é‚®ç®±ä¿¡æ¯`
   - **é€šè®¯å½•** â†’ `è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯`
   - **æ¶ˆæ¯ä¸ç¾¤ç»„** â†’ `å‘é€æ¶ˆæ¯`
4. ç‚¹å‡» **"ç¡®å®š"**

### æˆªå›¾å‚è€ƒ

```
æƒé™ç®¡ç†é¡µé¢åº”è¯¥æ˜¾ç¤ºï¼š
âœ“ contact:user.email:readonly
âœ“ contact:user:readonly  
âœ“ im:message
```

---

## ä¸‰ã€å‘å¸ƒåº”ç”¨

### æ­¥éª¤ 1: åˆ›å»ºç‰ˆæœ¬

1. å·¦ä¾§èœå•ç‚¹å‡» **"ç‰ˆæœ¬ç®¡ç†ä¸å‘å¸ƒ"**
2. ç‚¹å‡» **"åˆ›å»ºç‰ˆæœ¬"**
3. å¡«å†™ç‰ˆæœ¬ä¿¡æ¯ï¼š
   - **ç‰ˆæœ¬å·**: `1.0.0`
   - **æ›´æ–°è¯´æ˜**: `åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒç¾æœ¯èµ„æºå˜æ›´é€šçŸ¥`
4. ç‚¹å‡» **"ä¿å­˜"**

### æ­¥éª¤ 2: ç”³è¯·å‘å¸ƒ

1. ç‚¹å‡» **"ç”³è¯·å‘å¸ƒ"**
2. é€‰æ‹© **"ä»…ä¼ä¸šå†…éƒ¨ä½¿ç”¨"**
3. æäº¤å®¡æ ¸

**æ³¨æ„**: 
- ä¼ä¸šå†…éƒ¨åº”ç”¨é€šå¸¸ä¼šè‡ªåŠ¨é€šè¿‡
- å¦‚æœéœ€è¦ç®¡ç†å‘˜å®¡æ ¸ï¼Œè”ç³»å…¬å¸é£ä¹¦ç®¡ç†å‘˜

### æ­¥éª¤ 3: ç¡®è®¤å‘å¸ƒ

1. å®¡æ ¸é€šè¿‡åï¼Œç‚¹å‡» **"å‘å¸ƒ"**
2. åº”ç”¨çŠ¶æ€å˜ä¸º **"å·²å‘å¸ƒ"**

---

## å››ã€æµ‹è¯•åº”ç”¨æƒé™

### æ–¹æ³• 1: ä½¿ç”¨ Postman æµ‹è¯•

#### 1. è·å– Access Token

```http
POST https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal
Content-Type: application/json

{
  "app_id": "ä½ çš„APP_ID",
  "app_secret": "ä½ çš„APP_SECRET"
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "tenant_access_token": "t-xxxxxxxxxxxxx",
  "expire": 7200
}
```

#### 2. æµ‹è¯•æŸ¥æ‰¾ç”¨æˆ·

```http
POST https://open.feishu.cn/open-apis/contact/v3/users/batch_get_id?user_id_type=open_id
Authorization: Bearer t-xxxxxxxxxxxxx
Content-Type: application/json

{
  "emails": ["wangxinlai@huixuanjiasu.com"]
}
```

**é¢„æœŸå“åº”**:
```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "user_list": [
      {
        "user_id": "ou_xxxxxxxxxxxxx",
        "email": "wangxinlai@huixuanjiasu.com"
      }
    ]
  }
}
```

### æ–¹æ³• 2: ä½¿ç”¨ Python è„šæœ¬æµ‹è¯•

```python
import requests
import json

APP_ID = "ä½ çš„APP_ID"
APP_SECRET = "ä½ çš„APP_SECRET"
TEST_EMAIL = "wangxinlai@huixuanjiasu.com"

# 1. è·å– Token
def get_token():
    url = "https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal"
    body = {"app_id": APP_ID, "app_secret": APP_SECRET}
    r = requests.post(url, json=body)
    data = r.json()
    if data.get('code') == 0:
        print(f"âœ“ Token è·å–æˆåŠŸ: {data['tenant_access_token'][:20]}...")
        return data['tenant_access_token']
    else:
        print(f"âœ— Token è·å–å¤±è´¥: {data}")
        return None

# 2. æŸ¥æ‰¾ç”¨æˆ·
def find_user(token):
    url = "https://open.feishu.cn/open-apis/contact/v3/users/batch_get_id?user_id_type=open_id"
    body = {"emails": [TEST_EMAIL]}
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    r = requests.post(url, json=body, headers=headers)
    data = r.json()
    if data.get('code') == 0:
        user_list = data.get('data', {}).get('user_list', [])
        if user_list:
            print(f"âœ“ ç”¨æˆ·æŸ¥æ‰¾æˆåŠŸ: {user_list[0]}")
            return user_list[0]['user_id']
        else:
            print(f"âœ— æœªæ‰¾åˆ°ç”¨æˆ·: {TEST_EMAIL}")
    else:
        print(f"âœ— æŸ¥æ‰¾ç”¨æˆ·å¤±è´¥: {data}")
    return None

# 3. å‘é€æµ‹è¯•æ¶ˆæ¯
def send_message(token, user_id):
    url = "https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=open_id"
    content = json.dumps({"text": "ğŸ‰ é£ä¹¦é€šçŸ¥æµ‹è¯•æˆåŠŸï¼"})
    body = {
        "receive_id": user_id,
        "msg_type": "text",
        "content": content
    }
    headers = {"Authorization": f"Bearer {token}", "Content-Type": "application/json"}
    r = requests.post(url, json=body, headers=headers)
    data = r.json()
    if data.get('code') == 0:
        print(f"âœ“ æ¶ˆæ¯å‘é€æˆåŠŸï¼")
        return True
    else:
        print(f"âœ— æ¶ˆæ¯å‘é€å¤±è´¥: {data}")
        return False

# è¿è¡Œæµ‹è¯•
if __name__ == "__main__":
    print("=== é£ä¹¦åº”ç”¨æƒé™æµ‹è¯• ===\n")
    
    token = get_token()
    if not token:
        exit(1)
    
    user_id = find_user(token)
    if not user_id:
        exit(1)
    
    send_message(token, user_id)
    
    print("\n=== æµ‹è¯•å®Œæˆ ===")
```

ä¿å­˜ä¸º `test_feishu.py`ï¼Œè¿è¡Œï¼š
```powershell
python test_feishu.py
```

---

## äº”ã€å¸¸è§é—®é¢˜

### é—®é¢˜ 1: "app_access_token invalid"

**åŸå› **: App Secret é”™è¯¯æˆ–åº”ç”¨æœªå‘å¸ƒ

**è§£å†³**:
1. æ£€æŸ¥ App ID å’Œ App Secret æ˜¯å¦æ­£ç¡®
2. ç¡®è®¤åº”ç”¨å·²å‘å¸ƒ
3. é‡æ–°ç”Ÿæˆ App Secretï¼ˆå¦‚æœæ³„éœ²ï¼‰

### é—®é¢˜ 2: "permission denied"

**åŸå› **: åº”ç”¨æƒé™ä¸è¶³

**è§£å†³**:
1. æ£€æŸ¥æƒé™ç®¡ç†ä¸­æ˜¯å¦æ·»åŠ äº†å¿…éœ€æƒé™
2. é‡æ–°åˆ›å»ºç‰ˆæœ¬å¹¶å‘å¸ƒ
3. ç­‰å¾…å‡ åˆ†é’Ÿè®©æƒé™ç”Ÿæ•ˆ

### é—®é¢˜ 3: "user not found"

**åŸå› **: 
- é‚®ç®±ä¸æ˜¯é£ä¹¦ä¼ä¸šé‚®ç®±
- ç”¨æˆ·æœªåŠ å…¥é£ä¹¦ä¼ä¸š
- é‚®ç®±æ‹¼å†™é”™è¯¯

**è§£å†³**:
1. ç¡®è®¤é‚®ç®±æ˜¯ `@huixuanjiasu.com` ç»“å°¾
2. ç¡®è®¤ç”¨æˆ·å·²åŠ å…¥é£ä¹¦ä¼ä¸š
3. åœ¨é£ä¹¦é€šè®¯å½•ä¸­æœç´¢è¯¥ç”¨æˆ·

### é—®é¢˜ 4: "send message failed"

**åŸå› **: 
- ç”¨æˆ·æœªæ·»åŠ æœºå™¨äººä¸ºå¥½å‹
- åº”ç”¨æ²¡æœ‰å‘é€æ¶ˆæ¯æƒé™

**è§£å†³**:
1. ä¼ä¸šè‡ªå»ºåº”ç”¨ä¸éœ€è¦æ·»åŠ å¥½å‹
2. æ£€æŸ¥ `im:message` æƒé™æ˜¯å¦å¼€å¯
3. ç¡®è®¤åº”ç”¨å·²å‘å¸ƒ

---

## å…­ã€å®‰å…¨å»ºè®®

### 1. ä¿æŠ¤å‡­è¯

```powershell
# âœ— ä¸è¦è¿™æ ·åš
$APP_SECRET = "xxxxx"  # ç¡¬ç¼–ç åœ¨è„šæœ¬ä¸­

# âœ“ åº”è¯¥è¿™æ ·åš
$APP_SECRET = $env:FEISHU_APP_SECRET  # ä»ç¯å¢ƒå˜é‡è¯»å–
```

### 2. é™åˆ¶æƒé™

åªç”³è¯·å¿…éœ€çš„æƒé™ï¼Œä¸è¦ç”³è¯·è¿‡å¤šæƒé™ã€‚

### 3. å®šæœŸæ›´æ¢å¯†é’¥

å»ºè®®æ¯ 3-6 ä¸ªæœˆæ›´æ¢ä¸€æ¬¡ App Secretï¼š
1. é£ä¹¦å¼€æ”¾å¹³å° â†’ å‡­è¯ä¸åŸºç¡€ä¿¡æ¯
2. ç‚¹å‡» **"é‡ç½® Secret"**
3. æ›´æ–° GitLab ç¯å¢ƒå˜é‡

### 4. ç›‘æ§ä½¿ç”¨æƒ…å†µ

å®šæœŸæŸ¥çœ‹åº”ç”¨è°ƒç”¨æ—¥å¿—ï¼š
1. é£ä¹¦å¼€æ”¾å¹³å° â†’ åº”ç”¨è¯¦æƒ…
2. æŸ¥çœ‹ **"è°ƒç”¨ç»Ÿè®¡"**
3. æ£€æŸ¥å¼‚å¸¸è°ƒç”¨

---

## ä¸ƒã€å¿«é€Ÿå‚è€ƒ

### å‡­è¯ä½ç½®
```
é£ä¹¦å¼€æ”¾å¹³å° â†’ åº”ç”¨è¯¦æƒ… â†’ å‡­è¯ä¸åŸºç¡€ä¿¡æ¯
- App ID: cli_xxxxxxxxxxxxx
- App Secret: xxxxxxxxxxxxx
```

### å¿…éœ€æƒé™
```
contact:user.email:readonly
contact:user:readonly
im:message
```

### æµ‹è¯• API
```
Token: https://open.feishu.cn/open-apis/auth/v3/tenant_access_token/internal
æŸ¥æ‰¾ç”¨æˆ·: https://open.feishu.cn/open-apis/contact/v3/users/batch_get_id
å‘é€æ¶ˆæ¯: https://open.feishu.cn/open-apis/im/v1/messages
```

### é…ç½®åˆ° GitLab
```
GitLab é¡¹ç›® â†’ è®¾ç½® â†’ CI/CD â†’ å˜é‡
- FEISHU_APP_ID = cli_xxxxxxxxxxxxx
- FEISHU_APP_SECRET = xxxxxxxxxxxxx
```

---

## å…«ã€ä¸‹ä¸€æ­¥

è·å–å‡­è¯åï¼š

1. **æœ¬åœ°æµ‹è¯•**
   ```powershell
   $env:FEISHU_APP_ID = "ä½ çš„APP_ID"
   $env:FEISHU_APP_SECRET = "ä½ çš„APP_SECRET"
   cd E:\K_Kiro_Work\Feishu_Notify_Setup
   python notify.py
   ```

2. **é…ç½®åˆ° GitLab**
   - é¡¹ç›®è®¾ç½® â†’ CI/CD â†’ å˜é‡
   - æ·»åŠ  `FEISHU_APP_ID` å’Œ `FEISHU_APP_SECRET`

3. **éƒ¨ç½²åˆ°å…¬å¸å·¥ç¨‹**
   - å‚è€ƒ `éƒ¨ç½²åˆ°å…¬å¸å·¥ç¨‹æŒ‡å—.md`

---

**åˆ›å»ºæ—¶é—´**: 2026-01-14
**å®˜æ–¹æ–‡æ¡£**: https://open.feishu.cn/document/home/introduction-to-custom-app-development/self-built-application-development-process
