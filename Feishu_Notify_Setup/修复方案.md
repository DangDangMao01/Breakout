# 飞书通知系统修复方案

## 问题诊断

### 1. Git 策略冲突
- **问题**: `GIT_STRATEGY: none` 导致无法获取变动文件
- **原因**: `git diff` 需要 Git 仓库，但被禁用了

### 2. 路径错误
- **问题**: 切换到 `C:\GitLab-Runner` 找不到 `owners.json`
- **原因**: 配置文件在项目仓库，不在 Runner 目录

### 3. 环境变量缺失
- **问题**: 飞书 API 认证失败
- **原因**: 未配置 `FEISHU_APP_ID` 和 `FEISHU_APP_SECRET`

---

## 完整修复方案

### 步骤 1: 修复 .gitlab-ci.yml

```yaml
stages:
  - notify

notify_art_update:
  stage: notify
  tags:
    - windows
  variables:
    # ✅ 使用 fetch 策略，只拉取必要的提交
    GIT_STRATEGY: fetch
    GIT_DEPTH: 2  # 只拉取最近 2 个提交，够用且快
    PYTHONIOENCODING: "utf-8"
  script:
    - echo "=== 开始美术资源变动检测 ==="
    - echo "当前目录: %CD%"
    - echo "提交人: %GITLAB_USER_NAME%"
    - echo "提交 SHA: %CI_COMMIT_SHA%"
    
    # ✅ 在项目目录下运行，能找到 owners.json
    - cd Feishu_Notify_Setup
    - python notify.py
  only:
    changes:
      - Y_遇水发财/**/*
      - N_奶奶的小农院/**/*
      - T_天才连一连/**/*
  allow_failure: true
  retry: 1
```

### 步骤 2: 配置 GitLab 环境变量

1. 进入 GitLab 项目页面
2. 设置 → CI/CD → 变量（Variables）
3. 添加以下变量：

| Key | Value | Protected | Masked |
|-----|-------|-----------|--------|
| `FEISHU_APP_ID` | 你的飞书应用 ID | ✓ | ✓ |
| `FEISHU_APP_SECRET` | 你的飞书应用密钥 | ✓ | ✓ |

### 步骤 3: 优化 notify.py（可选）

```python
# 在 main() 函数开头添加调试信息
def main():
    print(">>> 开始检查美术资源变动...")
    print(f"当前工作目录: {os.getcwd()}")
    print(f"CI_COMMIT_SHA: {os.environ.get('CI_COMMIT_SHA')}")
    print(f"CI_COMMIT_BEFORE_SHA: {os.environ.get('CI_COMMIT_BEFORE_SHA')}")
    
    # 检查配置文件是否存在
    if not os.path.exists('owners.json'):
        print(f"错误: 找不到 owners.json，当前目录: {os.getcwd()}")
        print(f"目录内容: {os.listdir('.')}")
        return
    
    # ... 原有代码
```

---

## 测试步骤

### 1. 本地测试（推荐）

```powershell
# 设置环境变量（临时）
$env:FEISHU_APP_ID = "你的APP_ID"
$env:FEISHU_APP_SECRET = "你的APP_SECRET"
$env:CI_COMMIT_SHA = "HEAD"
$env:CI_COMMIT_BEFORE_SHA = "HEAD~1"
$env:GITLAB_USER_NAME = "测试用户"

# 运行脚本
cd Feishu_Notify_Setup
python notify.py
```

### 2. GitLab CI 测试

```bash
# 提交一个测试文件
echo "test" > Y_遇水发财/test.txt
git add .
git commit -m "test: 测试飞书通知"
git push

# 查看 GitLab CI 日志
# 项目页面 → CI/CD → Pipelines → 点击最新的 Pipeline
```

---

## 常见错误排查

### 错误 1: "获取 Token 失败"
```
原因: FEISHU_APP_ID 或 FEISHU_APP_SECRET 未配置
解决: 在 GitLab 项目设置中添加环境变量
```

### 错误 2: "找不到 owners.json"
```
原因: 脚本运行目录不对
解决: 确保 .gitlab-ci.yml 中有 `cd Feishu_Notify_Setup`
```

### 错误 3: "获取 Git 变动失败"
```
原因: GIT_STRATEGY: none 导致没有 Git 仓库
解决: 改为 GIT_STRATEGY: fetch
```

### 错误 4: "未找到该邮箱对应的用户"
```
原因: 
1. 邮箱不是飞书企业邮箱
2. 用户未加入飞书企业
3. 飞书应用权限不足

解决:
1. 确认邮箱是飞书企业邮箱
2. 确认用户已加入企业
3. 飞书管理后台 → 应用权限 → 开启"通讯录读取"权限
```

---

## 飞书应用配置检查

### 必需权限
1. **通讯录读取** - 查找用户
2. **发送消息** - 发送私聊
3. **获取用户信息** - 通过邮箱查找

### 配置步骤
1. 登录飞书开放平台: https://open.feishu.cn
2. 进入你的应用
3. 权限管理 → 添加权限：
   - `contact:user.email:readonly`
   - `im:message`
   - `contact:user:readonly`
4. 版本管理 → 创建版本 → 发布

---

## 进阶优化

### 1. 使用卡片消息（更美观）

```python
def send_card_message(user_id, project_name, user_name, token):
    """发送卡片消息"""
    card = {
        "config": {"wide_screen_mode": True},
        "header": {
            "title": {"tag": "plain_text", "content": "🎨 美术资源更新提醒"},
            "template": "blue"
        },
        "elements": [
            {
                "tag": "div",
                "fields": [
                    {"is_short": True, "text": {"tag": "lark_md", "content": f"**📁 项目**\n{project_name}"}},
                    {"is_short": True, "text": {"tag": "lark_md", "content": f"**👤 提交人**\n{user_name}"}}
                ]
            },
            {
                "tag": "action",
                "actions": [
                    {
                        "tag": "button",
                        "text": {"tag": "plain_text", "content": "查看变更"},
                        "url": os.environ.get('CI_PROJECT_URL', ''),
                        "type": "primary"
                    }
                ]
            }
        ]
    }
    
    url = "https://open.feishu.cn/open-apis/im/v1/messages?receive_id_type=open_id"
    body = {
        "receive_id": user_id,
        "msg_type": "interactive",
        "content": json.dumps(card)
    }
    headers = {"Authorization": "Bearer " + token, "Content-Type": "application/json"}
    
    try:
        r = requests.post(url, json=body, headers=headers)
        return r.json().get('code') == 0
    except Exception as e:
        print(f"发送卡片消息失败: {e}")
        return False
```

### 2. 添加变更文件列表

```python
# 在 main() 中
for file_path in changed_files:
    parts = file_path.split('/')
    if not parts:
        continue
    project_name = parts[0]
    
    if project_name in owners:
        # 收集该项目的所有变更文件
        if project_name not in project_changes:
            project_changes[project_name] = []
        project_changes[project_name].append(file_path)

# 发送时包含文件列表
for project_name, files in project_changes.items():
    email = owners[project_name]
    file_list = '\n'.join([f"  - {f}" for f in files[:5]])  # 最多显示 5 个
    if len(files) > 5:
        file_list += f"\n  ... 还有 {len(files) - 5} 个文件"
    
    msg = f"【美术资源更新提醒】\n📁 项目：{project_name}\n👤 提交人：{user_name}\n📝 变更文件:\n{file_list}\n🚀 请及时拉取最新资源！"
```

---

## 总结

### 核心修改
1. ✅ `GIT_STRATEGY: fetch` 替代 `none`
2. ✅ `cd Feishu_Notify_Setup` 进入正确目录
3. ✅ 配置飞书环境变量
4. ✅ 添加 `only: changes` 只在相关文件变动时触发

### 预期效果
- 提交代码后自动触发
- 识别变动的项目
- 通知对应负责人
- 失败不阻塞流水线

---

**创建时间**: 2026-01-14
**适用场景**: GitLab + 飞书企业自建应用
