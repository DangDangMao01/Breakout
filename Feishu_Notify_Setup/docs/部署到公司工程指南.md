# 部署到公司美术工程指南

> 目标仓库: `D:\HuiXuanJiaSu\I_IAA_Work`
> GitLab: https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb.git

## 一、部署前准备

### 1. 更新 owners.json（必须）

根据公司实际项目和负责人更新配置：

```json
{
    "Y_遇水发财": "zhangsan@huixuanjiasu.com",
    "N_奶奶的小农院": "lisi@huixuanjiasu.com",
    "T_天才连一连2": "wangwu@huixuanjiasu.com",
    "B_百味炊烟": "your_email@huixuanjiasu.com",
    "C_猜歌之王": "your_email@huixuanjiasu.com",
    "C_村头菜市场": "your_email@huixuanjiasu.com",
    "D_倒水排排序": "your_email@huixuanjiasu.com",
    "G_改装消消消": "your_email@huixuanjiasu.com",
    "G_根本消不完": "your_email@huixuanjiasu.com",
    "G_GGDT": "your_email@huixuanjiasu.com",
    "J_进场打螺丝": "your_email@huixuanjiasu.com",
    "T_Tile Global Trip-MVP": "your_email@huixuanjiasu.com",
    "W_旺财小店": "your_email@huixuanjiasu.com",
    "W_我不是歌神": "your_email@huixuanjiasu.com",
    "X_消消好运来-MVP": "your_email@huixuanjiasu.com",
    "测试文件": "your_email@huixuanjiasu.com"
}
```

**注意**：
- 邮箱必须是飞书企业邮箱
- 不需要配置的项目可以删除
- `Cocos_Project` 和 `Unity_Project` 是工程文件夹，通常不需要配置

### 2. 配置 GitLab 环境变量

1. 登录 GitLab: https://gitlab.huixuanjiasu.com
2. 进入项目: `grouptwogame/grouptowart_hb`
3. 设置 → CI/CD → 变量（Variables）→ 展开
4. 添加以下变量：

| Key | Value | Type | Protected | Masked |
|-----|-------|------|-----------|--------|
| `FEISHU_APP_ID` | cli_a5xxxxxxxxxxxxxx | Variable | ✓ | ✓ |
| `FEISHU_APP_SECRET` | xxxxxxxxxxxxxxxx | Variable | ✓ | ✓ |

**获取飞书应用凭证**：
1. 登录飞书开放平台: https://open.feishu.cn
2. 进入你的应用
3. 凭证与基础信息 → 复制 App ID 和 App Secret

### 3. 检查 GitLab Runner

确认公司 GitLab 有可用的 Windows Runner：

```powershell
# 在公司工程目录执行
cd D:\HuiXuanJiaSu\I_IAA_Work
git config --get remote.origin.url
```

如果没有 Runner，需要联系运维配置。

---

## 二、部署步骤

### 步骤 1: 复制文件

```powershell
# 复制整个 Feishu_Notify_Setup 文件夹到公司工程根目录
Copy-Item -Path "E:\K_Kiro_Work\Feishu_Notify_Setup" -Destination "D:\HuiXuanJiaSu\I_IAA_Work\" -Recurse -Force
```

### 步骤 2: 更新 owners.json

```powershell
# 编辑配置文件
notepad "D:\HuiXuanJiaSu\I_IAA_Work\Feishu_Notify_Setup\owners.json"
```

填入实际的项目和负责人邮箱。

### 步骤 3: 复制 .gitlab-ci.yml 到根目录

```powershell
# 如果根目录已有 .gitlab-ci.yml，需要合并
Copy-Item "D:\HuiXuanJiaSu\I_IAA_Work\Feishu_Notify_Setup\.gitlab-ci.yml" -Destination "D:\HuiXuanJiaSu\I_IAA_Work\.gitlab-ci.yml" -Force
```

**如果已有 .gitlab-ci.yml**，需要合并内容：

```yaml
# 原有的 stages
stages:
  - build
  - test
  - notify  # 添加这个

# ... 原有的 jobs ...

# 添加飞书通知 job
notify_art_update:
  stage: notify
  tags:
    - windows
  variables:
    GIT_STRATEGY: fetch
    GIT_DEPTH: 2
    PYTHONIOENCODING: "utf-8"
  script:
    - echo "=== 开始美术资源变动检测 ==="
    - cd Feishu_Notify_Setup
    - python notify.py
  only:
    changes:
      - Y_遇水发财/**/*
      - N_奶奶的小农院/**/*
      - T_天才连一连2/**/*
      - B_百味炊烟/**/*
      - C_猜歌之王/**/*
      - C_村头菜市场/**/*
      - D_倒水排排序/**/*
      - G_改装消消消/**/*
      - G_根本消不完/**/*
      - G_GGDT/**/*
      - J_进场打螺丝/**/*
      - T_Tile Global Trip-MVP/**/*
      - W_旺财小店/**/*
      - W_我不是歌神/**/*
      - X_消消好运来-MVP/**/*
  allow_failure: true
  retry: 1
```

### 步骤 4: 提交到 GitLab

```powershell
cd D:\HuiXuanJiaSu\I_IAA_Work

# 添加文件
git add Feishu_Notify_Setup/
git add .gitlab-ci.yml

# 提交
git commit -m "feat: 添加飞书自动通知系统"

# 推送
git push origin master
```

---

## 三、测试验证

### 本地测试（推荐先测试）

```powershell
# 设置环境变量
$env:FEISHU_APP_ID = "你的APP_ID"
$env:FEISHU_APP_SECRET = "你的APP_SECRET"
$env:CI_COMMIT_SHA = "HEAD"
$env:CI_COMMIT_BEFORE_SHA = "HEAD~1"
$env:GITLAB_USER_NAME = "测试用户"

# 进入目录
cd D:\HuiXuanJiaSu\I_IAA_Work\Feishu_Notify_Setup

# 运行测试
python notify.py
```

**预期输出**：
```
>>> 开始检查美术资源变动...
当前工作目录: D:\HuiXuanJiaSu\I_IAA_Work\Feishu_Notify_Setup
检测到项目 [Y_遇水发财] 变动，准备通知: zhangsan@huixuanjiasu.com
--> 通知发送成功！
```

### GitLab CI 测试

```powershell
# 修改一个测试文件
cd D:\HuiXuanJiaSu\I_IAA_Work
echo "test" > Y_遇水发财/test.txt

# 提交
git add Y_遇水发财/test.txt
git commit -m "test: 测试飞书通知"
git push

# 查看 GitLab CI 日志
# 浏览器打开: https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb/-/pipelines
```

---

## 四、常见问题

### 问题 1: Python 未安装

```powershell
# 检查 Python
python --version

# 如果没有，安装 Python 3.8+
# 下载: https://www.python.org/downloads/
```

### 问题 2: requests 模块未安装

```powershell
pip install requests
```

### 问题 3: GitLab Runner 找不到 Python

在 `.gitlab-ci.yml` 中指定完整路径：

```yaml
script:
  - C:\Python39\python.exe notify.py
```

### 问题 4: 飞书应用权限不足

需要在飞书管理后台开启以下权限：
- `contact:user.email:readonly` - 通过邮箱查找用户
- `im:message` - 发送消息
- `contact:user:readonly` - 获取用户信息

### 问题 5: 通知发送失败

检查：
1. 邮箱是否是飞书企业邮箱
2. 用户是否已加入飞书企业
3. 飞书应用是否已发布
4. 环境变量是否配置正确

---

## 五、目录结构（部署后）

```
D:\HuiXuanJiaSu\I_IAA_Work\
├─ .gitlab-ci.yml              # GitLab CI 配置
├─ Feishu_Notify_Setup/        # 飞书通知系统
│  ├─ notify.py                # 通知脚本
│  ├─ owners.json              # 负责人配置
│  ├─ 修复方案.md              # 问题修复文档
│  └─ 部署到公司工程指南.md    # 本文档
├─ Y_遇水发财/                 # 项目文件夹
├─ N_奶奶的小农院/
├─ T_天才连一连2/
└─ ... 其他项目
```

---

## 六、维护指南

### 添加新项目

1. 编辑 `owners.json`，添加项目和负责人
2. 编辑 `.gitlab-ci.yml`，在 `only: changes` 中添加项目路径
3. 提交并推送

### 更换负责人

直接修改 `owners.json` 中的邮箱，提交即可生效。

### 暂停通知

在 `.gitlab-ci.yml` 中添加：

```yaml
notify_art_update:
  when: manual  # 改为手动触发
```

或者直接注释掉整个 job。

---

## 七、安全建议

1. **不要提交密钥到代码仓库**
   - ✓ 使用 GitLab 环境变量
   - ✗ 不要在代码中硬编码

2. **限制环境变量访问**
   - 勾选 `Protected` - 只在保护分支可用
   - 勾选 `Masked` - 日志中隐藏值

3. **定期更新密钥**
   - 每 3-6 个月更换一次飞书应用密钥

---

## 八、快速命令参考

```powershell
# 一键部署（调试完成后）
Copy-Item -Path "E:\K_Kiro_Work\Feishu_Notify_Setup" -Destination "D:\HuiXuanJiaSu\I_IAA_Work\" -Recurse -Force
cd D:\HuiXuanJiaSu\I_IAA_Work
git add Feishu_Notify_Setup/ .gitlab-ci.yml
git commit -m "feat: 添加飞书自动通知系统"
git push

# 本地测试
cd D:\HuiXuanJiaSu\I_IAA_Work\Feishu_Notify_Setup
$env:FEISHU_APP_ID = "你的ID"
$env:FEISHU_APP_SECRET = "你的密钥"
python notify.py

# 查看 GitLab CI 日志
start https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb/-/pipelines
```

---

**创建时间**: 2026-01-14
**目标仓库**: D:\HuiXuanJiaSu\I_IAA_Work
**GitLab**: https://gitlab.huixuanjiasu.com/grouptwogame/grouptowart_hb
