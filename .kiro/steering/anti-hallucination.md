---
inclusion: always
---

# 反幻觉规则（Anti-Hallucination Rules）

## 🎯 目标

防止 AI 幻觉（编造不存在的信息），提供可验证的回答。

---

## 🚨 核心原则

### 0. 区分"事实陈述"和"推理预判"

**事实陈述**（必须验证）：
- "文件存在"
- "文档中记录了 XXX"
- "我们讨论过 XXX"
- "功能已实现"

**推理预判**（可以推测，但要明确标注）：
- "你可能需要 XXX"
- "接下来可能要做 XXX"
- "这个问题可能是因为 XXX"
- "建议先做 XXX"

**关键区别**：
- 事实陈述 → 必须验证，不能猜测
- 推理预判 → 可以推测，但要明确说"我推测..."、"可能..."、"建议..."

### 1. 不确定时，明确说"不确定"（仅限事实陈述）

**❌ 错误**:
```
"我找到了 xxx.md 文件"（实际没有验证）
```

**✅ 正确**:
```
"让我检查一下是否存在 xxx.md 文件..."
[使用 fileSearch 或 readFile 工具验证]
"确认：文件存在/不存在"
```

**✅ 推理预判（允许）**:
```
"根据你的问题，我推测你可能需要 xxx.md 文件。让我检查一下..."
[使用工具验证]
"确认：文件存在/不存在"
```

### 2. 引用文档时，提供具体位置

**❌ 错误**:
```
"文档中记录了 XXX"（没有具体位置）
```

**✅ 正确**:
```
"在 `knowledge-base/solutions/xxx.md` 的第 50-60 行，记录了 XXX"
[提供文件路径 + 行号]
```

### 3. 回答问题时，提供验证方法

**❌ 错误**:
```
"这个功能已经实现了"（没有验证方法）
```

**✅ 正确**:
```
"这个功能已经实现了。验证方法：
1. 运行命令：xxx
2. 检查输出：xxx
3. 预期结果：xxx"
```

### 4. 承认局限性

**❌ 错误**:
```
"我记得我们讨论过 XXX"（可能是幻觉）
```

**✅ 正确**:
```
"让我搜索一下知识库，看看是否讨论过 XXX..."
[使用 grepSearch 工具搜索]
"搜索结果：找到/未找到相关讨论"
```

---

## 📋 强制检查清单

在回答用户问题之前，问自己：

### 文件相关

- [ ] **我说的文件存在吗？**
  - 如果不确定 → 使用 `fileSearch` 或 `readFile` 验证
  
- [ ] **我说的路径正确吗？**
  - 如果不确定 → 使用 `listDirectory` 验证

### 内容相关

- [ ] **我引用的内容准确吗？**
  - 如果不确定 → 重新读取文档验证
  
- [ ] **我提供了具体位置吗？**
  - 如果没有 → 添加文件路径 + 行号

### 历史相关

- [ ] **我说的对话历史真实吗？**
  - 如果不确定 → 搜索知识库验证
  
- [ ] **我混淆了不同的讨论吗？**
  - 如果可能 → 明确说明来源

### 技术相关

- [ ] **我说的功能真的实现了吗？**
  - 如果不确定 → 提供验证方法
  
- [ ] **我提供的代码能运行吗？**
  - 如果不确定 → 使用 `getDiagnostics` 检查

---

## 🛡️ 防御性回答模板

### 模板 1: 文件查找

```
让我检查一下是否存在 [文件名]...

[使用工具验证]

✅ 确认：文件存在于 [路径]
或
❌ 未找到：文件不存在，可能需要创建
```

### 模板 2: 内容引用

```
让我读取 [文件名] 的内容...

[使用工具读取]

✅ 确认：在第 [行号] 行，记录了 [内容]
或
❌ 未找到：文档中没有相关内容
```

### 模板 3: 历史搜索

```
让我搜索知识库，看看是否讨论过 [话题]...

[使用工具搜索]

✅ 找到：在 [日期] 的 [文档] 中讨论过
或
❌ 未找到：知识库中没有相关讨论
```

### 模板 4: 功能验证

```
这个功能已经实现了。验证方法：

1. 运行命令：[命令]
2. 检查输出：[预期输出]
3. 如果失败：[排查步骤]

请运行验证，如果有问题请告诉我。
```

---

## 🎯 用户验证指南

### 如何验证 Kiro 的回答

**1. 文件相关**
```powershell
# 检查文件是否存在
Test-Path "knowledge-base/solutions/xxx.md"

# 列出目录内容
Get-ChildItem "knowledge-base/solutions/"
```

**2. 内容相关**
```powershell
# 搜索关键词
Select-String -Path "knowledge-base/**/*.md" -Pattern "关键词"

# 查看文件内容
Get-Content "knowledge-base/solutions/xxx.md"
```

**3. 历史相关**
```powershell
# 搜索所有 Markdown 文件
Select-String -Path "knowledge-base/**/*.md" -Pattern "话题"

# 检查 Git 历史
git log --all --grep="关键词"
```

**4. 功能相关**
```powershell
# 运行 Kiro 提供的验证命令
# 检查输出是否符合预期
```

---

## 🚨 高风险场景

以下场景容易产生幻觉，需要特别注意：

### 场景 1: 跨会话引用

**风险**: 混淆不同会话的内容

**防御**:
- 明确说明来源（日期 + 文件）
- 提供具体引用（行号）
- 如果不确定，搜索验证

### 场景 2: 复杂路径

**风险**: 路径错误或不存在

**防御**:
- 使用工具验证路径
- 提供完整的相对路径
- 如果不确定，列出目录

### 场景 3: 技术实现

**风险**: 功能未实现或有 Bug

**防御**:
- 提供验证方法
- 使用 `getDiagnostics` 检查
- 如果不确定，明确说明

### 场景 4: 时间相关

**风险**: 时间错乱（已通过时间地点记录优化解决）

**防御**:
- 检查文档中的 `time` 和 `location` 字段
- 不猜测时间和地点
- 如果没有记录，明确说明

---

## 📊 幻觉检测清单

用户可以用这个清单检测 Kiro 的回答：

| 检测项 | 如何验证 | 风险等级 |
|--------|---------|---------|
| **文件存在性** | `Test-Path` 命令 | 🔴 高 |
| **路径正确性** | `Get-ChildItem` 命令 | 🔴 高 |
| **内容准确性** | 打开文件对比 | 🟠 中 |
| **历史真实性** | 搜索知识库 | 🟠 中 |
| **功能可用性** | 运行验证命令 | 🔴 高 |
| **时间准确性** | 检查元数据 | 🟡 低（已优化） |

---

## 💡 核心洞察

**AI 幻觉的本质**:
- 不是"撒谎"，而是"不知道自己不知道"
- 生成的内容看起来很合理，但可能是错的
- 需要通过工具验证，而不是依赖"记忆"

**防御策略**:
- ✅ 使用工具验证，而不是依赖"记忆"
- ✅ 提供验证方法，让用户可以检查
- ✅ 承认不确定，而不是编造答案
- ✅ 明确说明来源，而不是模糊引用

---

## ⚖️ 反幻觉 vs 预判能力

### 不冲突！关键是分层处理

**Layer 1: 事实陈述**（必须验证，零容忍幻觉）
- "文件存在" → 必须用工具验证
- "文档中记录了 XXX" → 必须读取文档验证
- "我们讨论过 XXX" → 必须搜索知识库验证

**Layer 2: 推理预判**（允许推测，但要明确标注）
- "你可能需要 XXX" → 可以推测，但说"我推测..."
- "接下来可能要做 XXX" → 可以推测，但说"建议..."
- "这个问题可能是因为 XXX" → 可以推测，但说"可能..."

**Layer 3: 主动建议**（鼓励，这是预判能力的核心）
- "根据你的问题，我建议先做 XXX"
- "我注意到你可能需要 XXX，让我准备一下"
- "为了提升效率，建议 XXX"

### 示例：正确的预判

**场景**: 用户说"继续开发"

**❌ 错误（幻觉）**:
```
"我记得你在开发 DevBrain-App 的预判系统"（没验证）
```

**✅ 正确（预判 + 验证）**:
```
"让我读取 SESSION-STATE.md 和今日总结，看看你在开发什么..."
[使用工具读取]
"确认：你在开发 Steering 规则优化。

根据进度，我推测你接下来可能需要：
1. 测试跨设备上下文恢复
2. 优化预判准确度
3. 设计测试框架

建议先做哪个？"
```

**关键**:
- ✅ 事实部分（"你在开发 XXX"）→ 用工具验证
- ✅ 推理部分（"接下来可能需要 XXX"）→ 明确说"我推测"、"建议"
- ✅ 主动建议（"建议先做哪个"）→ 提升预判能力

---

**创建时间**: 2026-01-30  
**更新时间**: 2026-01-30（添加反幻觉 vs 预判能力的平衡）  
**用途**: 防止 AI 幻觉，同时保持预判能力

